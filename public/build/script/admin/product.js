let pProductImportValidator,pProductAlterValidator,currentProduct;function productHistoryKardex(e,t,[,o]){var a={};a.filter=JSON.stringify([{id:SnUniqueId(),logicalOperator:"or",prefix:"DONDE",eval:[{id:"800216",logicalOperator:"and",prefix:"DONDE",operator:"es",field:"product_id_barcode",type:"text",value1:o,value2:""}]}]),navigatorGoTo("/admin/maintenanceKardex",a,screenName)}function productImportSubmit(t){var e,o;pProductImportValidator.validate()?null!=(e=document.getElementById("productImportFile"))&&(void 0===e.files||null==(e=e.files[0])?SnModal.danger({title:"ALERTA USUARIO",content:"Por favor, selecciona al menos un archivo para continuar."}):validateFile(e,["application/vnd.openxmlformats-officedocument.spreadsheetml.sheet","application/vnd.ms-excel"],3e3)&&((o=new FormData).append("excelFile",e),o.append("updateDescription",t.productUpdateDescription.checked?1:0),o.append("updatePurchasePrice",t.productUpdatePurchasePrice.checked?1:0),o.append("updatePublicPrices",t.productUpdatePublicPrices.checked?1:0),o.append("updateStock",t.productUpdateStock.checked?1:0),o.append("setNewProducts",t.productSetNewProducts.checked?1:0),SnLoadingState(!0,"jsAction","productImportModalFormSubmit"),RequestApi.fetch("/admin/maintenanceProduct/import",{method:"POST",body:o}).then(e=>{e.success?(SnModal.success({title:"PROCESO COMPLETO",content:e.message}),SnModal.close("productImportModal"),maintenanceTable.getData()):dynamicResponseErrorModalMessage(e),t.reset()}).finally(e=>{SnLoadingState(!1,"jsAction","productImportModalFormSubmit")}))):dynamicFormSubmitInvalidMessage("No se especificó ningún archivo")}function productImport(e){SnModal.open("productImportModal")}function productDowloandExcel(e,t){window.open(URL_PATH+"/admin/"+t+"/dowloand","_blank")}function productAlter(e,t,[o]){SnLoadingState(!0,"jsAction"),RequestApi.fetch("/admin/maintenanceProduct/idSearch",{method:"POST",body:{id:o}}).then(e=>{e.success?(currentProduct=e.result,document.getElementById("productAlterStock").value=parseFloat(currentProduct.product.stock??0),document.getElementById("productAlterIsLot").value=currentProduct.product.lot,document.getElementById("productAlterInput").value=0,document.getElementById("productAlterOutput").value=0,productAlterCalculate(currentProduct.product),SnModal.open("productAlterModal")):dynamicResponseErrorModalMessage(e)}).finally(e=>{SnLoadingState(!1,"jsAction")})}function productAlterCalculate(e){const r=document.getElementById("productAlterStock"),d=document.getElementById("productAlterInput"),c=document.getElementById("productAlterOutput"),i=parseFloat(e.stock||0),t=(e=1)=>{let t=parseFloat(r.value||0),o=parseFloat(d.value||0),a=parseFloat(c.value||0);switch(e){case 1:var l=i-t;l<0?(o=Math.abs(l),a=0):0<l?(a=Math.abs(l),o=0):(o=0,a=0);break;case 2:t=i+o,a=0;break;case 3:t=i-a,o=0}r.value=t,d.value=o,c.value=a};[...document.querySelectorAll('input[name="alterStock"]')].forEach(e=>{e.addEventListener("change",()=>{switch(e.value){case"1":r.removeAttribute("disabled"),d.setAttribute("disabled",!0),c.setAttribute("disabled",!0),r.focus();break;case"2":r.setAttribute("disabled",!0),d.removeAttribute("disabled"),c.setAttribute("disabled",!0),d.focus();break;case"3":r.setAttribute("disabled",!0),d.setAttribute("disabled",!0),c.removeAttribute("disabled"),c.focus()}})}),r.addEventListener("input",()=>{t(1)}),d.addEventListener("input",()=>{t(2)}),c.addEventListener("input",()=>{t(3)})}function productAlterSubmit(t){if(pProductAlterValidator.validate()){let e={};e.id=currentProduct.product.id,e.description=currentProduct.product.description,e.stock=t.productAlterStock.value,e.lot=t.productAlterIsLot.value,"0"==e.lot?SnModal.confirm({title:"¿Estás seguro de actualizar el stock de este producto?",content:"Esta operación es irreversible",okText:"Si",okClassNames:"danger",cancelText:"No",onOk(){SnLoadingState(!0,"jsAction"),RequestApi.fetch("/admin/maintenanceProduct/alter",{method:"POST",body:e}).then(e=>{e.success?(SnMessage.success({content:e.message}),maintenanceTable.getData(),SnModal.close("productAlterModal")):dynamicResponseErrorModalMessage(e)}).finally(e=>{SnLoadingState(!1,"jsAction")})}}):productLotLoad(e)}else dynamicFormSubmitInvalidMessage()}function productClone(e,t,[]){alert("en desarrollo...")}function productPrintBanrcode(e,t,[]){alert("en desarrollo...")}function productLotLoad(t){SnLoadingState(!0,"jsAction"),RequestApi.fetch("/admin/maintenanceLot/allByProduct",{method:"POST",body:{productId:t.id}}).then(e=>{e.success?(document.getElementById("lotProcessTableBody").innerHTML="",[...e.result].forEach(e=>{lotProcessTableBodyAdd({id:e.id,number:e.number,initialStock:parseFloat(e.initial_stock??0),currentStock:parseFloat(e.current_stock??0),manufacturingDate:e.manufacturing_date,expirationDate:e.expiration_date,customsName:e.customs_name,customsDocumentDate:e.customs_document_date,petition:e.petition})}),document.getElementById("lotProcessProductId").value=t.id,document.getElementById("lotProcessProduct").value=t.description,document.getElementById("lotProcessQuantity").value=t.stock,lotProcessCalculate(),SnModal.open("lotProcessModal")):dynamicResponseErrorModalMessage(e)})}function lotProcessModalSubmit(){let m=[],p=document.getElementById("lotProcessProductId").value;[...document.getElementById("lotProcessTableBody").children].map((e,t)=>{var o=e.dataset.delete,e=e.dataset.id,a=document.getElementById("lotProcessTableBodyRowNumber"+e).innerHTML,l=document.getElementById("lotProcessTableBodyRowInitialStock"+e).innerHTML,r=document.getElementById("lotProcessTableBodyRowCurrentStock"+e).innerHTML,d=document.getElementById("lotProcessTableBodyRowManufacturingDate"+e).innerHTML,c=document.getElementById("lotProcessTableBodyRowExpirationDate"+e).innerHTML,i=document.getElementById("lotProcessTableBodyRowCustomsName"+e).innerHTML,n=document.getElementById("lotProcessTableBodyRowCustomsDocumentDate"+e).innerHTML,s=document.getElementById("lotProcessTableBodyRowPetition"+e).innerHTML,u={};u.id=e,u.delete=1==o,u.number=a,u.initialStock=l,u.currentStock=r,u.manufacturingDate=d,u.expirationDate=c,u.productId=p,u.customsName=i,u.customsDocumentDate=n,u.petition=s,m.push(u)});var e=lotProcessCalculate();0!=e?SnModal.warning({title:"ALERTA USUARIO",content:"La existencia actual en lote es "+(0<e?"mayor":"menor")+" a la existencia captura, no se puede continuar así"}):(SnLoadingState(!0,"jsAction","lotProcessModalSubmit"),RequestApi.fetch("/admin/maintenanceLot/create",{method:"POST",body:m}).then(e=>{e.success?(SnMessage.success({content:e.message}),maintenanceTable.getData(),SnModal.close("lotProcessModal"),SnModal.close("productAlterModal")):dynamicResponseErrorModalMessage(e)}).finally(e=>{SnLoadingState(!1,"jsAction","lotProcessModalSubmit")}))}document.addEventListener("DOMContentLoaded",()=>{pProductImportValidator=dynamicLoadFormValidate(pProductImportValidator,"productImportModalForm"),pProductAlterValidator=dynamicLoadFormValidate(pProductAlterValidator,"productAlterModalForm"),maintenanceTable=new SnTable({elementId:"drawProductTable",entity:"product",data:e=>snTableFetchData("/admin/maintenanceProduct/table",e),actions:appMenuActions,selectable:!1,paramKeys:["id","barcode"],columns:[{title:"Código",field:"barcode",filterable:!0,sortable:!0},{title:"Descripción",field:"description",filterable:!0,sortable:!0},{title:"Categoría",field:"category_id_description",filterable:!0,sortable:!0},{title:"SUNAT Código",field:"product_catalog_code",filterable:!0,sortable:!0,visible:!1},{title:"SUNAT Descripción",field:"product_catalog_description",filterable:!0,sortable:!0,visible:!1},{title:"Precio Compra",field:"purchase_price",filterable:!0,sortable:!0,customRender:e=>`${operability.currency_id_symbol} ${e.purchase_price} <small>${e.purchase_unit_measure_id_code}</small>`},{title:"Precio Venta",field:"sale_price_1",filterable:!0,sortable:!0,customRender:e=>`${operability.currency_id_symbol} ${e.sale_price_1} <small>${e.sale_unit_measure_id_code}</small>`},{title:"C.M. Mayoreo 2",field:"whole_sale_2",filterable:!0,sortable:!0,visible:!1,customRender:e=>`${e.whole_sale_2} <small>${e.sale_unit_measure_id_code}</small>`},{title:"P.V. Mayoreo 2",field:"sale_price_2",filterable:!0,sortable:!0,visible:!1,customRender:e=>`${operability.currency_id_symbol} ${e.sale_price_2} <small>${e.sale_unit_measure_id_code}</small>`},{title:"C.M. Mayoreo 3",field:"whole_sale_3",filterable:!0,sortable:!0,visible:!1,customRender:e=>`${e.whole_sale_3} <small>${e.sale_unit_measure_id_code}</small>`},{title:"P.V. Mayoreo 3",field:"sale_price_3",filterable:!0,sortable:!0,visible:!1,customRender:e=>`${operability.currency_id_symbol} ${e.sale_price_3} <small>${e.sale_unit_measure_id_code}</small>`},{title:"Unidad medida",field:"sale_unit_measure_id_code",filterable:!0,sortable:!0},{title:"Stock",field:"stock",filterable:!0,sortable:!0,customRender:e=>{let t="";return parseFloat(e.stock)<=parseFloat(e.stock_min)?t="var(--red-6)":parseFloat(e.stock_max)>parseFloat(e.stock_min)&&parseFloat(e.stock)>=parseFloat(e.stock_max)&&(t="var(--yellow-6)"),`<span style="color: ${t}">${parseFloat(e.stock||0)}</span>`}},{title:'<i class="fa-solid fa-receipt"></i>',tooltip:"Se requiere receta médica para su venta",field:"recipe",style:"width: 32px;",filterable:!0,sortable:!0,customRender:e=>"1"==e.recipe?'<i class="fa-solid fa-check-double" title="Se requiere receta médica para su venta"></i>':""},{title:'<i class="fas fa-puzzle-piece"></i>',tooltip:"Compatibles seleccionados",field:"recipe",style:"width: 32px;",filterable:!0,sortable:!0,customRender:e=>""},{title:'<i class="fas fa-cubes"></i>',tooltip:"Manejo por lotes",style:"width: 32px;",field:"lot",filterable:!0,sortable:!0,customRender:(e,t)=>"1"==e.lot?'<i class="fa-solid fa-check-double" title="Manejo por lotes"></i>':""},{title:'<i class="fas fa-fill"></i>',tooltip:"Este producto maneja varias presentaciones",style:"width: 32px;",field:"recipe",filterable:!0,sortable:!0,customRender:e=>""},...snTableAuditColumnRender()],filters:[...getUrlFilter()]});const t=document.getElementById("productImportModalForm"),o=(t.addEventListener("submit",function(e){e.preventDefault(),productImportSubmit(t)}),document.getElementById("productAlterModalForm"));o.addEventListener("submit",function(e){e.preventDefault(),productAlterSubmit(o)})});