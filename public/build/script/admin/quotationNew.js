let pQuotationValidator,currentCurrencySymbol="";function newQuotationSubmit(){var e,t;pQuotationValidator.validate()?((e={}).pdfFormat=document.getElementById("quotationPdfFormat").value,e.observation=document.getElementById("quotationObservation").value,e.documentNumber=document.getElementById("quotationDocumentNumber").value,e.socialReason=document.getElementById("quotationSocialReason").value,e.fiscalAddress=document.getElementById("quotationFiscalAddress").value,e.email=document.getElementById("quotationEmail").value,e.phone=document.getElementById("quotationPhone").value,e.customerId=document.getElementById("quotationCustomerId").value,e.identityDocumentId=document.getElementById("quotationIdentityDocumentId").value,e.totalFree=document.getElementById("quotationTotalFree").value,e.totalExportation=document.getElementById("quotationTotalExportation").value,e.totalDiscount=document.getElementById("quotationTotalDiscount").value,e.totalExonerated=document.getElementById("quotationTotalExonerated").value,e.totalUnaffected=document.getElementById("quotationTotalUnaffected").value,e.totalTaxed=document.getElementById("quotationTotalTaxed").value,e.totalIgv=document.getElementById("quotationTotalIgv").value,e.totalCharge=document.getElementById("quotationTotalCharge").value,e.totalValue=document.getElementById("quotationTotalValue").value,e.totalPlasticBagTax=document.getElementById("quotationTotalPlasticBagTax").value,e.total=document.getElementById("quotationTotal").value,e.currencyId=document.getElementById("quotationCurrencyId").value,e.quotationItems=[],t=document.getElementById("quotationItemTableBody"),e.quotationItems=[...t.children].map((e,t)=>{var e=e.id.split("_")[1],o=document.getElementById("product_unit_price_"+e).value,n=document.getElementById("product_affectation_igv_type_id_"+e).value,a=document.getElementById("product_quantity_"+e).value,d=document.getElementById("product_discount_"+e).value,l=document.getElementById("product_unit_value_"+e).value,i=document.getElementById("product_total_value_"+e).value,u=document.getElementById("product_igv_"+e).value;return{quantity:a,unitValue:l,unitPrice:o,discount:d,charge:0,affectationIgvTypeId:n,totalBaseIgv:document.getElementById("product_total_base_igv_"+e).value,igv:u,totalValue:i,total:document.getElementById("product_total_"+e).innerHTML,unitMeasureId:document.getElementById("product_sale_unit_measure_id_"+e).value,productId:e}}),quotationValidateProcess(e)&&(SnLoadingState(!0,"jsAction","newQuotationFormSubmit"),RequestApi.fetch("/admin/processQuotation/save",{method:"POST",body:e}).then(e=>{e.success?(SnMessage.success({content:e.message}),iframePrintModal(e.result.customPdf),newQuotationClear()):dynamicResponseErrorModalMessage(e)}).finally(e=>{SnLoadingState(!1,"jsAction","newQuotationFormSubmit")}))):dynamicFormSubmitInvalidMessage()}function quotationValidateProcess(e){return 0==e.quotationItems.lenght?(SnModal.warning({title:"ALERTA USUARIO",content:"Ingrese al menos un producto en los detalles"}),!1):0<e.total||(SnModal.warning({title:"ALERTA USUARIO",content:"El total no puede ser menor que 0"}),!1)}function searchProductByCode(e){SnLoadingState(!0,"jsAction"),RequestApi.fetch("/admin/maintenanceProduct/barCodeSearch",{method:"POST",body:{barCode:e}}).then(e=>{e.success?e.result?(SnMessage.success({content:"Producto encontrado"}),quotationAddItem(e.result)):SnMessage.warning({content:"No se encontró ningún producto"}):dynamicResponseErrorModalMessage(e)}).finally(e=>{SnLoadingState(!1,"jsAction")})}function quotationAddItem(t){var e=document.getElementById("quotationItemTableBody"),o=document.getElementById("product_"+t.id);let n="";affectationIgvTypes.forEach(e=>{n+=`<option value="${e.id}">${e.description}</option>`}),o?(o=document.getElementById("product_quantity_"+t.id)).value=parseFloat(o.value)+1:(e.insertAdjacentHTML("beforeend",`<tr id="product_${t.id}">
                                                            <td>
                                                                <input id="product_quantity_${t.id}" min="1" type="number" class="SnForm-control" value="${t.quantity||1}" style="width: 80px">
                                                                <input type="hidden" class="SnForm-control" value="${t.barcode}">
                                                                <input id="product_sale_unit_measure_id_${t.id}" type="hidden" class="SnForm-control" value="${t.sale_unit_measure_id}">
                                                            </td>
                                                            <td>${t.description}</td>
                                                            <td id="product_stock_${t.id}">${parseFloat(t.stock)} ${t.sale_unit_measure_id_description}</td>
                                                            <td>
                                                                <input id="product_discount_${t.id}" min="0" type="number" class="SnForm-control" value="0" style="width: 80px">
                                                            </td>
                                                            <td>
                                                                <input id="product_unit_price_${t.id}" min="0" type="number" class="SnForm-control" value="${t.sale_price_1}">
                                                                <input id="product_unit_value_${t.id}" type="hidden" class="SnForm-control" value="${t.sale_price_1}">
                                                            </td>
                                                            <td>
                                                                <select id="product_affectation_igv_type_id_${t.id}" class="SnForm-control">${n}</select>
                                                                <input id="product_total_base_igv_${t.id}" type="hidden" class="SnForm-control" value="0">
                                                                <input id="product_igv_${t.id}" type="hidden" class="SnForm-control" value="0">
                                                                <input id="product_total_value_${t.id}" type="hidden" class="SnForm-control" value="0">
                                                            </td>
                                                            <td id="product_total_${t.id}"></td>
                                                            <td><button id="product_remove_${t.id}" class="SnBtn error icon radio" type="button"><i class="fas fa-trash"></i></button></td>
                                                        </tr>`),document.getElementById("product_quantity_"+t.id).addEventListener("change",e=>{quotationItemCalculate()}),document.getElementById("product_discount_"+t.id).addEventListener("change",e=>{quotationItemCalculate()}),document.getElementById("product_unit_price_"+t.id).addEventListener("change",e=>{quotationItemCalculate()}),document.getElementById("product_unit_value_"+t.id).addEventListener("change",e=>{quotationItemCalculate()}),document.getElementById("product_affectation_igv_type_id_"+t.id).addEventListener("change",e=>{quotationItemCalculate()}),document.getElementById("product_remove_"+t.id).addEventListener("click",e=>{quotationItemRemove(t.id)})),quotationItemCalculate()}function quotationItemRemove(e){document.getElementById("product_"+e).remove(),quotationItemCalculate()}function quotationItemCalculate(){[...document.getElementById("quotationItemTableBody").children].map((e,t)=>{e=e.id.split("_")[1];let o=document.getElementById("product_unit_price_"+e).value;var n=document.getElementById("product_affectation_igv_type_id_"+e).value,a=document.getElementById("product_quantity_"+e).value,d=document.getElementById("product_discount_"+e).value;let l=document.getElementById("product_unit_value_"+e).value;o=parseFloat(o),n=parseInt(n),a=parseFloat(a),d=parseFloat(d),l=parseFloat(l);let i,u,c,r;i=(c=1===n?(l=o/1.18,r=a*l-d,.18*(u=r)):(l=o,r=a*l-d,u=r,0),r+c),document.getElementById("product_unit_price_"+e).value=o,document.getElementById("product_unit_value_"+e).value=l,document.getElementById("product_total_base_igv_"+e).value=u,document.getElementById("product_igv_"+e).value=c,document.getElementById("product_total_value_"+e).value=r,document.getElementById("product_total_"+e).innerHTML=i.toFixed(2)}),quotationTotalCalculate()}function quotationTotalCalculate(){let l=0,i=0,u=0,c=0,r=0,m=0,s=0,y=0,p=0;[...document.getElementById("quotationItemTableBody").children].map((e,t)=>{var e=e.id.split("_")[1],o=document.getElementById("product_affectation_igv_type_id_"+e).value,n=document.getElementById("product_quantity_"+e).value,a=document.getElementById("product_discount_"+e).value,d=document.getElementById("product_total_value_"+e).value,e=document.getElementById("product_igv_"+e).value,o=parseInt(o),n=parseFloat(n),a=parseFloat(a),d=parseFloat(d),e=parseFloat(e);switch(o){case 1:c+=d;break;case 8:l+=d;break;case 9:i+=d;break;case 2:case 3:case 4:case 5:case 6:case 7:case 10:case 11:case 12:case 13:case 14:case 15:s+=d;break;case 16:u+=d}r+=e,m+=a,p+=n,y++});var e=s,t=+l,o=+i,n=+u,a=+c,d=0+m,g=t+o+n+a+r;document.getElementById("summaryTotalLines").innerHTML=y,document.getElementById("summaryTotalCuantity").innerHTML=p,(document.getElementById("summaryTotalWeight").innerHTML=0)<e?document.getElementById("quotationTotalFreeContainer").classList.remove("hidden"):document.getElementById("quotationTotalFreeContainer").classList.add("hidden"),document.getElementById("quotationTotalFree").value=e,document.getElementById("quotationTotalFreeHtml").innerHTML=currentCurrencySymbol+" "+e.toFixed(2),0<n?document.getElementById("quotationTotalExportationContainer").classList.remove("hidden"):document.getElementById("quotationTotalExportationContainer").classList.add("hidden"),document.getElementById("quotationTotalExportation").value=n,document.getElementById("quotationTotalExportationHtml").innerHTML=currentCurrencySymbol+" "+n.toFixed(2),0<d?document.getElementById("quotationTotalDiscountContainer").classList.remove("hidden"):document.getElementById("quotationTotalDiscountContainer").classList.add("hidden"),document.getElementById("quotationTotalDiscount").value=d,document.getElementById("quotationTotalDiscountHtml").innerHTML=currentCurrencySymbol+" "+d.toFixed(2),0<t?document.getElementById("quotationTotalExoneratedContainer").classList.remove("hidden"):document.getElementById("quotationTotalExoneratedContainer").classList.add("hidden"),document.getElementById("quotationTotalExonerated").value=t,document.getElementById("quotationTotalExoneratedHtml").innerHTML=currentCurrencySymbol+" "+t.toFixed(2),0<o?document.getElementById("quotationTotalUnaffectedContainer").classList.remove("hidden"):document.getElementById("quotationTotalUnaffectedContainer").classList.add("hidden"),document.getElementById("quotationTotalUnaffected").value=o,document.getElementById("quotationTotalUnaffectedHtml").innerHTML=currentCurrencySymbol+" "+o.toFixed(2),0<a?document.getElementById("quotationTotalTaxedContainer").classList.remove("hidden"):document.getElementById("quotationTotalTaxedContainer").classList.add("hidden"),document.getElementById("quotationTotalTaxed").value=a,document.getElementById("quotationTotalTaxedHtml").innerHTML=currentCurrencySymbol+" "+a.toFixed(2),0<r?document.getElementById("quotationTotalIgvContainer").classList.remove("hidden"):document.getElementById("quotationTotalIgvContainer").classList.add("hidden"),document.getElementById("quotationTotalIgv").value=r,document.getElementById("quotationTotalIgvHtml").innerHTML=currentCurrencySymbol+" "+r.toFixed(2),document.getElementById("quotationTotalCharge").value=0,document.getElementById("quotationTotalValue").value=0,document.getElementById("quotationTotalPlasticBagTax").value=0,document.getElementById("quotationTotal").value=g,document.getElementById("quotationTotalHtml").innerHTML=currentCurrencySymbol+" "+g.toFixed(2)}function newQuotationClear(){dynamicClearForm(pQuotationValidator,"newQuotationForm","quotationSearchProductCode","quotationItemTableBody"),document.getElementById("quotationTotalFreeHtml").innerHTML=currentCurrencySymbol+" 0",document.getElementById("quotationTotalExportationHtml").innerHTML=currentCurrencySymbol+" 0",document.getElementById("quotationTotalDiscountHtml").innerHTML=currentCurrencySymbol+" 0",document.getElementById("quotationTotalExoneratedHtml").innerHTML=currentCurrencySymbol+" 0",document.getElementById("quotationTotalUnaffectedHtml").innerHTML=currentCurrencySymbol+" 0",document.getElementById("quotationTotalTaxedHtml").innerHTML=currentCurrencySymbol+" 0",document.getElementById("quotationTotalIgvHtml").innerHTML=currentCurrencySymbol+" 0",document.getElementById("quotationTotalChargeHtml").innerHTML=currentCurrencySymbol+" 0",document.getElementById("quotationTotalValueHtml").innerHTML=currentCurrencySymbol+" 0",document.getElementById("quotationTotalPlasticBagTaxHtml").innerHTML=currentCurrencySymbol+" 0",document.getElementById("quotationTotalHtml").innerHTML=currentCurrencySymbol+" 0",document.getElementById("quotationDomicileCondition").innerHTML=""}function quotationNewList(e,t){window.location.href=URL_PATH+"/admin/"+t}function quotationNewSearchProduct(){SnModal.open("productSearchModal"),pProductSearchTable=new SnTable({elementId:"drawSearchProductTable",entity:"product",data:e=>snTableFetchData("/admin/maintenanceProduct/tableSearch",e),actions:[],selectable:!1,columns:[{title:"Código",field:"barcode",filterable:!0,sortable:!0},{title:"Descripción",field:"description",filterable:!0,sortable:!0},{title:"Precio 1",field:"sale_price_1",filterable:!0,sortable:!0},{title:"Precio 2",field:"sale_price_2",filterable:!0,sortable:!0},{title:"Precio 3",field:"sale_price_3",filterable:!0,sortable:!0},{title:"Unidad medida",field:"sale_unit_measure_id_description",filterable:!0,sortable:!0},{title:'<i class="fa-solid fa-receipt"></i>',tooltip:"Se requiere receta médica para su venta",field:"recipe",style:"width: 32px;",filterable:!0,sortable:!0,customRender:e=>"1"==e.recipe?'<i class="fa-solid fa-check-double" title="Se requiere receta médica para su venta"></i>':""},{title:'<i class="fas fa-puzzle-piece"></i>',tooltip:"Compatibles seleccionados",field:"recipe",style:"width: 32px;",filterable:!0,sortable:!0,customRender:e=>""},{title:'<i class="fas fa-cubes"></i>',tooltip:"Manejo por lotes",style:"width: 32px;",field:"lot",filterable:!0,sortable:!0,customRender:(e,t)=>"1"==e.lot?'<i class="fa-solid fa-check-double" title="Manejo por lotes"></i>':""},{title:'<i class="fas fa-fill"></i>',tooltip:"Este producto maneja varias presentaciones",style:"width: 32px;",field:"recipe",filterable:!0,sortable:!0,customRender:e=>""},{title:"",field:"-",filterable:!1,sortable:!1,customRender:e=>`<div class="SnTable-action not-print">
                                <a href="${URL_PATH}/admin/maintenanceProduct/edit/${e.id}" target="_blank" class="SnBtn icon radio sm jsAction" title="Modificar">
                                    <i class="fas fa-pen"></i>
                                </a>
                            </div>`}],rowRender:(e,t,o)=>`<tr class="${0==e.state?"canceled":""}" key="${e.id}" ondblclick="selectRowProduct(${e.id})" data-params="${o}">
            ${t._buildSelectColumn(e)}
            ${t._buildDataRow(e)}
                        </tr>`})}function selectRowProduct(e){SnModal.close("productSearchModal"),SnLoadingState(!0,"jsAction"),RequestApi.fetch("/admin/maintenanceProduct/idSearch",{method:"POST",body:{id:e}}).then(e=>{e.success?quotationAddItem(e.result.product):dynamicResponseErrorModalMessage(e)}).finally(e=>{SnLoadingState(!1,"jsAction")})}function productSearchReload(){pProductSearchTable.getData()}function quotationSearchCustomer(){SnModal.open("customerSearchModal"),pCustomerSearchTable=new SnTable({elementId:"drawSearchCustomerTable",entity:"customer",data:e=>snTableFetchData("/admin/maintenanceCustomer/tableSearch",e),actions:[],selectable:!1,columns:[{title:"Tipo documento",field:"identity_document_id_description",filterable:!0,sortable:!0},{title:"Nº documento",field:"document_number",filterable:!0,sortable:!0},{title:"Razón social",field:"social_reason",filterable:!0,sortable:!0},{title:"Razón comercial",field:"commercial_reason",filterable:!0,sortable:!0},{title:"Dirección",field:"fiscal_address",filterable:!0,sortable:!0},{title:"Email",field:"email",filterable:!0,sortable:!0},{title:"Telefono",field:"telephone",filterable:!0,sortable:!0},{title:"",field:"-",filterable:!1,sortable:!1,customRender:e=>`<div class="SnTable-action not-print">
                                <a href="${URL_PATH}/admin/maintenanceCustomer/edit/${e.id}" target="_blank" class="SnBtn icon radio sm jsAction" title="Modificar">
                                    <i class="fas fa-pen"></i>
                                </a>
                            </div>`}],rowRender:(e,t,o)=>`<tr class="${0==e.state?"canceled":""}" key="${e.id}" ondblclick="selectRowCustomer(${e.id})" data-params="${o}">
            ${t._buildSelectColumn(e)}
            ${t._buildDataRow(e)}
                        </tr>`})}function selectRowCustomer(e){SnModal.close("customerSearchModal"),SnLoadingState(!0,"jsAction"),RequestApi.fetch("/admin/maintenanceCustomer/idSearch",{method:"POST",body:{id:e}}).then(e=>{e.success?(document.getElementById("quotationIdentityDocumentId").value=e.result.identity_document_id,document.getElementById("quotationDocumentNumber").value=e.result.document_number,document.getElementById("quotationSocialReason").value=e.result.social_reason,document.getElementById("quotationFiscalAddress").value=e.result.fiscal_address,document.getElementById("quotationEmail").value=e.result.email,document.getElementById("quotationPhone").value=e.result.telephone,document.getElementById("quotationCustomerId").value=e.result.id):dynamicResponseErrorModalMessage(e)}).finally(e=>{SnLoadingState(!1,"jsAction")})}function customerSearchReload(){pCustomerSearchTable.getData()}function getIdentityDocumentNumber(e,t){t.classList.add("loading"),RequestApi.fetch("/page/queryDocument",{method:"POST",body:{documentNumber:e}}).then(e=>{var t,o;e.success?(t=e.result,document.getElementById("quotationDocumentNumber").value=t.document_number,document.getElementById("quotationIdentityDocumentId").value=t.document_type_id,document.getElementById("quotationFiscalAddress").value=t.full_address,document.getElementById("quotationCustomerId").value=0,(o=document.getElementById("quotationDomicileCondition")).innerHTML=t.domicile_condition,"HABIDO"===t.domicile_condition?o.style.color="var(--green-6)":o.style.color="var(--red-6)",1==t.document_type_id?document.getElementById("quotationSocialReason").value=`${t.full_name} ${t.father_last_name} `+t.mother_last_name:3==t.document_type_id&&(document.getElementById("quotationSocialReason").value=t.full_name)):SnModal.danger({title:"Algo salió mal",content:e.message})}).finally(e=>{t.classList.remove("loading")})}document.addEventListener("DOMContentLoaded",()=>{pQuotationValidator=dynamicLoadFormValidate(pQuotationValidator,"newQuotationForm"),document.getElementById("newQuotationForm").addEventListener("submit",function(e){e.preventDefault(),newQuotationSubmit()});const t=document.getElementById("quotationSearchProductCode"),o=(t.addEventListener("keypress",function(e){"Enter"===e.key&&e.preventDefault()}),t.addEventListener("keyup",function(e){"Enter"===e.key&&(e.preventDefault(),searchProductByCode(e.target.value),t.value="")}),SnLiveList({elem:"#quotationSearchProductDescription",data:(e,o)=>{e.length<4?o("Escriba almenos 4 caracteres"):(o("Cargando..."),SnLoadingState(!0,"jsAction"),RequestApi.fetch("/admin/maintenanceProduct/descriptionSearch",{method:"POST",body:{description:e}}).then(e=>{var t;e.success?(t=e.result.map(e=>{var t=[{price:parseFloat(e.sale_price_1??0),whole:1},{price:parseFloat(e.sale_price_2??0),whole:parseFloat(e.whole_sale_2??0)},{price:parseFloat(e.sale_price_3??0),whole:parseFloat(e.whole_sale_3??0)}].filter(e=>0<e.price).map(e=>`(${e.whole}) <strong>${e.price}</strong>`).join(" , ");return{...e,text:e.description+`</br><i>${t}</i>`,value:e.id}}),o(t)):o(e.message)}).finally(e=>{SnLoadingState(!1,"jsAction")}))},onSelect:(e,t)=>{var o=document.getElementById("product_quantity_"+t.id);quotationAddItem(o?{...t,quantity:parseFloat(o.value)+1}:t),document.getElementById("quotationSearchProductDescription").value="",document.getElementById("quotationSearchProductDescription").focus()}}),document.getElementById("quotationDocumentNumber")),n=(o.addEventListener("keypress",function(e){"Enter"===e.key&&e.preventDefault()}),o.addEventListener("keyup",function(e){"Enter"===e.key&&(e.preventDefault(),getIdentityDocumentNumber(e.target.value,o))}),document.getElementById("quotationCurrencyId"));n.addEventListener("change",function(e){e.preventDefault(),currentCurrencySymbol=n.options[n.selectedIndex].getAttribute("data-symbol"),quotationTotalCalculate()}),currentCurrencySymbol=n.options[n.selectedIndex].getAttribute("data-symbol"),dynamicViewKeyboardListeners(screenName,appMenuActions)});