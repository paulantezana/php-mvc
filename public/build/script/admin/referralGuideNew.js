let pReferralGuideFormValidator,slimReferralGuideStartLocationId,slimReferralGuideArrivalLocationId;function initDefaultValues(){referralGuideT18TransportTypeIdChange(),referralGuideT20EeasonTransferIdChange()}function referralGuideSetDefaultValuesByDocumentType(e){const t=e.value,r=document.getElementById("referralGuideSerie");let a=[];["6","7"].includes(t)&&(a=wareHouseSeries.filter(e=>parseInt(e.document_type_id)===parseInt(t))),r.innerHTML="",a.forEach(e=>{r.insertAdjacentHTML("beforeend",`<option value="${e.serie}">${e.serie}</option>`)})}function newReferralGuideFormSubmit(){var e,t,r,a,d;pReferralGuideFormValidator.validate()?((e={}).t20EeasonTransferId=document.getElementById("referralGuideT20EeasonTransferId").value,e.t18TransportTypeId=document.getElementById("referralGuideT18TransportTypeId").value,e.transferStartDate=document.getElementById("referralGuideTransferStartDate").value,e.totalGrossWeight=document.getElementById("referralGuideTotalGrossWeight").value,e.numberPackages=document.getElementById("referralGuideNumberPackages").value,e.sunatIndicator=document.getElementById("referralGuideSunatIndicator").value,e.t61TransportGoodId=document.getElementById("referralGuideT61TransportGoodId").value,e.carrierIdentityDocumentId=document.getElementById("referralGuideCarrierIdentityDocumentId").value,e.carrierDocumentNumber=document.getElementById("referralGuideCarrierDocumentNumber").value,e.carrierDenomination=document.getElementById("referralGuideCarrierDenomination").value,e.carrierMTCNumber=document.getElementById("referralGuideCarrierMTCNumber").value,e.vehiclePlateNumber=document.getElementById("referralGuideVehiclePlateNumber").value,e.driverIdentityDocumentId=document.getElementById("referralGuideDriverIdentityDocumentId").value,e.driverDocumentNumber=document.getElementById("referralGuideDriverDocumentNumber").value,e.driverName=document.getElementById("referralGuideDriverName").value,e.driverLastName=document.getElementById("referralGuideDriverLastName").value,e.driverLicence=document.getElementById("referralGuideDriverLicence").value,e.startLocationId=document.getElementById("referralGuideStartLocationId").value,e.startAddress=document.getElementById("referralGuideStartAddress").value,e.startSunatEstablishment=document.getElementById("referralGuideStartSunatEstablishment").value,e.arrivalLocationId=document.getElementById("referralGuideArrivalLocationId").value,e.arrivalAddress=document.getElementById("referralGuideArrivalAddress").value,e.arrivalSunatEstablishment=document.getElementById("referralGuideArrivalSunatEstablishment").value,e.observation=document.getElementById("referralGuideObservation").value,e.documentTypeId=document.getElementById("referralGuideDocumentTypeId").value,e.customerId=document.getElementById("referralGuideCustomerId").value,e.serie=document.getElementById("referralGuideSerie").value,e.dateOfIssue=document.getElementById("referralGuideDateOfIssue").value,e.documentNumber=document.getElementById("referralGuideDocumentNumber").value,e.identityDocumentId=document.getElementById("referralGuideIdentityDocumentId").value,e.socialReason=document.getElementById("referralGuideSocialReason").value,e.fiscalAddress=document.getElementById("referralGuideFiscalAddress").value,e.email=document.getElementById("referralGuideEmail").value,e.phone=document.getElementById("referralGuidePhone").value,e.emailSend=!1,e.phoneSend=!1,t=document.getElementById("referralGuideItemTableBody"),r=document.getElementById("referralGuideInvoiceTableBody"),a=document.getElementById("referralGuideVehiclePlateNumberAditionalTableBody"),d=document.getElementById("referralGuideDriverAditionalTableBody"),e.items=[...t.children].map((e,t)=>{e=e.id.split("_")[1];return{productId:e,quantity:document.getElementById("product_quantity_"+e).value,description:document.getElementById("product_description_"+e).innerHTML,descriptionAditional:document.getElementById("product_description_aditional_"+e).value,damDsSerie:document.getElementById("product_dam_ds_serie_"+e).value,damDsNumber:document.getElementById("product_dam_ds_number_"+e).value,unitMeasureId:document.getElementById("product_sale_unit_measure_id_"+e).value}}),e.invoices=[...r.children].map((e,t)=>{e=e.id.split("_")[1];return{documentTypeId:document.getElementById("invoice_document_type_id_"+e).value,serie:document.getElementById("invoice_serie_"+e).value,number:document.getElementById("invoice_number_"+e).value}}),e.plateNumberAditionals=[...a.children].map((e,t)=>{e=e.id.split("_")[2];return{plateNumber:document.getElementById("plate_number_plate_number_"+e).value}}),e.driverAditionals=[...d.children].map((e,t)=>{e=e.id.split("_")[2];return{identityDocumentId:document.getElementById("driver_aditional_identity_document_id_"+e).value,documentNumber:document.getElementById("driver_aditional_document_number_"+e).value,name:document.getElementById("driver_aditional_name_"+e).value,lastName:document.getElementById("driver_aditional_last_name_"+e).value,driverLicence:document.getElementById("driver_aditional_driver_licence_"+e).value}}),SnLoadingState(!0,"jsAction","newReferralGuideFormSubmit"),RequestApi.fetch("/admin/processReferralGuide/save",{method:"POST",body:e}).then(e=>{var t;e.success?((t=e.result.sunat).success?SnMessage.success({content:t.message}):(SnModal.danger({title:"SUNAT ERROR",content:t.message}),SnMessage.danger({content:t.message})),referralGuideClear()):dynamicResponseErrorModalMessage(e)}).finally(e=>{SnLoadingState(!1,"jsAction","newReferralGuideFormSubmit")})):dynamicFormSubmitInvalidMessage()}function referralGuideClear(){dynamicClearForm(pReferralGuideFormValidator,"newReferralGuideForm","referralGuideT20EeasonTransferId"),initDefaultValues()}function referralGuidePrepareToInsert(t,e){var r=document.getElementById("referralGuideItemTableBody"),a=document.getElementById("product_"+t.id);let d='<option value="">Elegir</option>';unitMeasures&&unitMeasures.forEach(e=>{d+='<option value="'+e.id+'">'+e.description+"</option>"}),a?(a=document.getElementById("product_quantity_"+t.id)).value=parseFloat(a.value||0)+1:(r.insertAdjacentHTML("beforeend",`<tr id="product_${t.id}">
                                                            <td id="product_description_${t.id}">${t.description}</td>
                                                            <td>
                                                                <input id="product_description_aditional_${t.id}" type="text" class="SnForm-control" style="min-width: 80px">
                                                            </td>
                                                            <td>
                                                                <input id="product_quantity_${t.id}" min="0" type="number" class="SnForm-control" value="${t.quantity||1}">
                                                                <input id="product_barcode_${t.id}" type="hidden" class="SnForm-control" value="${t.barcode}">
                                                                <input id="product_sale_unit_measure_id_${t.id}" type="hidden" class="SnForm-control" value="${t.sale_unit_measure_id}">
                                                            </td>
                                                            <td>
                                                                <input id="product_dam_ds_serie_${t.id}" type="text" class="SnForm-control" style="min-width: 80px">
                                                            </td>
                                                            <td>
                                                                <input id="product_dam_ds_number_${t.id}" type="text" class="SnForm-control" style="min-width: 80px">
                                                            </td>
                                                            <td>
                                                                <select id="product_unit_measure_id_${t.id}" class="SnForm-control" style="min-width: 80px">${d}</select>
                                                            </td>
                                                            <td>
                                                                <button id="product_remove_${t.id}" class="SnBtn error icon radio" type="button"><i class="fas fa-trash"></i></button>
                                                            </td>
                                                        </tr>`),document.getElementById("product_remove_"+t.id).addEventListener("click",e=>{referralGuideItemRemove(t.id)}))}function referralGuideItemRemove(e){document.getElementById("product_"+e).remove(),referralGuideCalculate()}function referralGuideCalculate(){}function referralGuideNewList(e,t){window.location.href=URL_PATH+"/admin/"+t}function referralGuideT18TransportTypeIdChange(){var e=document.getElementById("referralGuideT18TransportTypeId").value,t=document.getElementById("referralGuideDriverContainer"),r=document.getElementById("referralGuideVehiclePlateNumberContainer"),a=document.getElementById("referralGuideVehiclePlateNumberAditionalTableContainer");"1"==e?(t.classList.add("hidden"),r.classList.add("hidden"),a.classList.add("hidden")):(t.classList.remove("hidden"),r.classList.remove("hidden"),a.classList.remove("hidden"))}function referralGuideT20EeasonTransferIdChange(){var e=document.getElementById("referralGuideT20EeasonTransferId").value,t=document.getElementById("referralGuideT61TransportGoodIdContainer");["4","5"].includes(e)?t.classList.remove("hidden"):t.classList.add("hidden")}document.addEventListener("DOMContentLoaded",()=>{pReferralGuideFormValidator=dynamicLoadFormValidate(pReferralGuideFormValidator,"newReferralGuideForm"),document.getElementById("newReferralGuideForm").addEventListener("submit",function(e){e.preventDefault(),newReferralGuideFormSubmit()}),document.getElementById("referralGuideT20EeasonTransferId").addEventListener("change",function(e){e.preventDefault(),referralGuideT20EeasonTransferIdChange()}),document.getElementById("referralGuideT18TransportTypeId").addEventListener("change",function(e){e.preventDefault(),referralGuideT18TransportTypeIdChange()});const t=document.getElementById("referralGuideDocumentNumber"),r=(t.addEventListener("keypress",function(e){"Enter"===e.key&&e.preventDefault()}),t.addEventListener("keyup",function(e){"Enter"===e.key&&(e.preventDefault(),getIdentityDocumentNumber(e.target.value,t))}),document.getElementById("referralGuideDocumentTypeId"));r.addEventListener("change",e=>{e.preventDefault(),referralGuideSetDefaultValuesByDocumentType(r)}),referralGuideSetDefaultValuesByDocumentType(r),slimReferralGuideStartLocationId=new SlimSelect({select:"#referralGuideStartLocationId",settings:{searchingText:"Buscando...",allowDeselect:!0},events:{search:(e,t)=>new Promise((r,a)=>{if(e.length<2)return a("Escriba almenos 2 caracteres");RequestApi.fetch("/page/searchLocation",{method:"POST",body:{search:e}}).then(e=>{var t;e.success?(t=e.result.map(e=>({text:e.description,value:e.id})),r(t)):a(e.message)}).catch(e=>{a(e)})})}}),slimReferralGuideArrivalLocationId=new SlimSelect({select:"#referralGuideArrivalLocationId",settings:{searchingText:"Buscando...",allowDeselect:!0},events:{search:(e,t)=>new Promise((r,a)=>{if(e.length<2)return a("Escriba almenos 2 caracteres");RequestApi.fetch("/page/searchLocation",{method:"POST",body:{search:e}}).then(e=>{var t;e.success?(t=e.result.map(e=>({text:e.description,value:e.id})),r(t)):a(e.message)}).catch(e=>{a(e)})})}}),initDefaultValues()});let productSearchTable;function referralGuideNewSearchProduct(){SnModal.open("productSearchModal"),productSearchTable=new SnTable({elementId:"drawSearchProductTable",entity:"product",selectable:!1,data:e=>snTableFetchData("/admin/maintenanceProduct/tableSearch",e),actions:[],columns:[{title:"Código",field:"barcode",filterable:!0,sortable:!0},{title:"Descripción",field:"description",filterable:!0,sortable:!0},{title:"Precio 1",field:"sale_price_1",filterable:!0,sortable:!0},{title:"Precio 2",field:"sale_price_2",filterable:!0,sortable:!0},{title:"Precio 3",field:"sale_price_3",filterable:!0,sortable:!0},{title:"Unidad medida",field:"sale_unit_measure_id_description",filterable:!0,sortable:!0},{title:"Stock",field:"stock",filterable:!0,sortable:!0},{title:'<i class="fa-solid fa-receipt"></i>',tooltip:"Se requiere receta médica para su venta",field:"recipe",style:"width: 32px;",filterable:!0,sortable:!0,customRender:e=>"1"==e.recipe?'<i class="fa-solid fa-check-double" title="Se requiere receta médica para su venta"></i>':""},{title:'<i class="fas fa-puzzle-piece"></i>',tooltip:"Compatibles seleccionados",field:"recipe",style:"width: 32px;",filterable:!0,sortable:!0,customRender:e=>""},{title:'<i class="fas fa-cubes"></i>',tooltip:"Manejo por lotes",style:"width: 32px;",field:"lot",filterable:!0,sortable:!0,customRender:(e,t)=>"1"==e.lot?'<i class="fa-solid fa-check-double" title="Manejo por lotes"></i>':""},{title:'<i class="fas fa-fill"></i>',tooltip:"Este producto maneja varias presentaciones",style:"width: 32px;",field:"recipe",filterable:!0,sortable:!0,customRender:e=>""},{title:"",field:"-",filterable:!1,sortable:!1,customRender:e=>`<div class="SnTable-action not-print">
                                <a href="${URL_PATH}/admin/maintenanceProduct/edit/${e.id}" target="_blank" class="SnBtn icon radio sm jsAction" title="Modificar">
                                    <i class="fas fa-pen"></i>
                                </a>
                            </div>`}],rowRender:(e,t,r)=>`<tr class="${0==e.state?"canceled":""}" key="${e.id}" title="Presiona doble clic en la fila para seleccionar un producto" ondblclick="selectRowProduct(${e.id})" data-params="${r}">
            ${t._buildSelectColumn(e)}
            ${t._buildDataRow(e)}
                        </tr>`})}function selectRowProduct(e){SnModal.close("productSearchModal"),SnLoadingState(!0,"jsAction"),RequestApi.fetch("/admin/maintenanceProduct/idSearch",{method:"POST",body:{id:e}}).then(e=>{e.success?referralGuidePrepareToInsert(e.result.product,e.result.lots):dynamicResponseErrorModalMessage(e)}).finally(e=>{SnLoadingState(!1,"jsAction")})}function productSearchReload(){productSearchTable.getData()}let customerSearchTable;function referralGuideNewChangeCustomer(){SnModal.open("customerSearchModal"),customerSearchTable=new SnTable({elementId:"drawSearchCustomerTable",entity:"customer",selectable:!1,data:e=>snTableFetchData("/admin/maintenanceCustomer/tableSearch",e),actions:[],columns:[{title:"Tipo documento",field:"identity_document_id_description",filterable:!0,sortable:!0},{title:"Nº documento",field:"document_number",filterable:!0,sortable:!0},{title:"Razón social",field:"social_reason",filterable:!0,sortable:!0},{title:"Razón comercial",field:"commercial_reason",filterable:!0,sortable:!0},{title:"Dirección",field:"fiscal_address",filterable:!0,sortable:!0},{title:"Email",field:"email",filterable:!0,sortable:!0},{title:"Telefono",field:"telephone",filterable:!0,sortable:!0},{title:"",field:"-",filterable:!1,sortable:!1,customRender:e=>`<div class="SnTable-action not-print">
                                <a href="${URL_PATH}/admin/maintenanceCustomer/edit/${e.id}" target="_blank" class="SnBtn icon radio sm jsAction" title="Modificar">
                                    <i class="fas fa-pen"></i>
                                </a>
                            </div>`}],rowRender:(e,t,r)=>`<tr class="${0==e.state?"canceled":""}" key="${e.id}" ondblclick="selectRowCustomer(${e.id})" title="Presiona doble clic en la fila para seleccionar un cliente" data-params="${r}">
                            ${t._buildSelectColumn(e)}
                            ${t._buildDataRow(e)}
                        </tr>`})}function selectRowCustomer(e){SnModal.close("customerSearchModal"),SnLoadingState(!0,"jsAction"),RequestApi.fetch("/admin/maintenanceCustomer/idSearch",{method:"POST",body:{id:e}}).then(e=>{e.success?(document.getElementById("referralGuideIdentityDocumentId").value=e.result.identity_document_id,document.getElementById("referralGuideDocumentNumber").value=e.result.document_number,document.getElementById("referralGuideSocialReason").value=e.result.social_reason,document.getElementById("referralGuideFiscalAddress").value=e.result.fiscal_address,document.getElementById("referralGuideEmail").value=e.result.email,document.getElementById("referralGuidePhone").value=e.result.telephone,document.getElementById("referralGuideCustomerId").value=e.result.id):dynamicResponseErrorModalMessage(e)}).finally(e=>{SnLoadingState(!1,"jsAction")})}function customerSearchReload(){customerSearchTable.getData()}function getIdentityDocumentNumber(e,t){t.classList.add("loading"),RequestApi.fetch("/page/queryDocument",{method:"POST",body:{documentNumber:e}}).then(e=>{var t,r,a;e.success?(t=e.result,document.getElementById("referralGuideDocumentNumber").value=t.document_number,document.getElementById("referralGuideIdentityDocumentId").value=t.document_type_id,document.getElementById("referralGuideFiscalAddress").value=t.full_address,document.getElementById("referralGuideCustomerId").value=0,r=document.getElementById("referralGuideTaxpayerCondition"),a=document.getElementById("referralGuideTaxpayerState"),r.innerHTML=`(${t.domicile_condition})`,a.innerHTML=`(${t.taxpayer_state})`,"HABIDO"===t.domicile_condition?r.style.color="var(--green-6)":r.style.color="var(--red-6)","ACTIVO"===t.taxpayer_state?a.style.color="var(--green-6)":a.style.color="var(--red-6)",1==t.document_type_id?document.getElementById("referralGuideSocialReason").value=`${t.full_name} ${t.father_last_name} `+t.mother_last_name:3==t.document_type_id&&(document.getElementById("referralGuideSocialReason").value=t.full_name)):SnModal.danger({title:"Algo salió mal",content:e.message})}).finally(e=>{t.classList.remove("loading")})}function referralGuideInvoiceAddItem(){var e=document.getElementById("referralGuideInvoiceTableBody");const t=e.childNodes.length+1;let r="";referenceDocumentTypes&&referenceDocumentTypes.forEach(e=>{r+='<option value="'+e.id+'">'+e.description+"</option>"}),e.insertAdjacentHTML("beforeend",`<tr id="invoice_${t}">
                                                        <td>
                                                            <select id="invoice_document_type_id_${t}" class="SnForm-control" style="min-width: 80px">
                                                              ${r}
                                                            </select>
                                                        </td>
                                                        <td>
                                                            <input id="invoice_serie_${t}" type="text" class="SnForm-control" style="min-width: 80px">
                                                        </td>
                                                        <td>
                                                            <input id="invoice_number_${t}" type="text" class="SnForm-control" style="min-width: 80px">
                                                        </td>
                                                        <td>
                                                            <button id="invoice_remove_${t}" class="SnBtn error icon radio" type="button"><i class="fas fa-trash"></i></button>
                                                        </td>
                                                    </tr>`),document.getElementById("invoice_remove_"+t).addEventListener("click",e=>{referralGuideInvoiceRemove(t)})}function referralGuideInvoiceRemove(e){document.getElementById("invoice_"+e).remove()}function referralGuidePlateNumberAddItem(){var e=document.getElementById("referralGuideVehiclePlateNumberAditionalTableBody");const t=e.childNodes.length+1;e.insertAdjacentHTML("beforeend",`<tr id="plate_number_${t}">
                                                        <td>
                                                            <input id="plate_number_plate_number_${t}" type="text" class="SnForm-control" style="min-width: 80px">
                                                        </td>
                                                        <td>
                                                            <button id="plate_number_remove_${t}" class="SnBtn error icon radio" type="button"><i class="fas fa-trash"></i></button>
                                                        </td>
                                                    </tr>`),document.getElementById("plate_number_remove_"+t).addEventListener("click",e=>{referralGuidePlateNumberRemove(t)})}function referralGuidePlateNumberRemove(e){document.getElementById("plate_number_"+e).remove()}function referralGuideDriverAditionalAddItem(){var e=document.getElementById("referralGuideDriverAditionalTableBody");const t=e.childNodes.length+1;let r="";identityDocumentTypes&&identityDocumentTypes.forEach(e=>{r+='<option value="'+e.id+'">'+e.description+"</option>"}),e.insertAdjacentHTML("beforeend",`<tr id="driver_aditional_${t}">
                                                        <td>
                                                            <select class="SnForm-control" id="driver_aditional_identity_document_id_${t}" required>
                                                            ${r}
                                                            </select>
                                                        </td>
                                                        <td>
                                                            <input type="text" class="SnForm-control" id="driver_aditional_document_number_${t}" required>
                                                        </td>
                                                        <td>
                                                          <input type="text" class="SnForm-control" id="driver_aditional_name_${t}" required>
                                                        </td>
                                                        <td>
                                                          <input type="text" class="SnForm-control" id="driver_aditional_last_name_${t}" required>
                                                        </td>
                                                        <td>
                                                            <input type="text" class="SnForm-control" id="driver_aditional_driver_licence_${t}">
                                                        </td>
                                                        <td>
                                                            <button id="driver_aditional_remove_${t}" class="SnBtn error icon radio" type="button"><i class="fas fa-trash"></i></button>
                                                        </td>
                                                    </tr>`),document.getElementById("driver_aditional_remove_"+t).addEventListener("click",e=>{referralGuideDriverAditionalRemove(t)})}function referralGuideDriverAditionalRemove(e){document.getElementById("driver_aditional_"+e).remove()}