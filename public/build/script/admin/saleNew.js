let pSaleValidator,pSalePaymentValidator,pUncontrolledProductValidator,pMovementValidator,pSalePrepare,pProcessQuantityValidator,pWalletValidator,slimSaleDetractionOriginLocationId,slimSaleDetractionArrivalLocationId,slimSaleGuideOriginLocationId,slimSaleGuideDeliveryLocationId;function saleNewMoreOption(){SnModal.open("saleHeaderMoreOption")}function saleSetOperationTypeValues(){var e=parseInt(document.getElementById("saleOperationTypeId").value||0);document.getElementById("saleDetractionContainerWrapper").classList.toggle("hidden",![3,5,6,7].includes(e)),document.getElementById("saleDetractionContainerTransWrapper").classList.toggle("hidden",![5].includes(e)),document.getElementById("saleDetractionContainerHidroWrapper").classList.toggle("hidden",![6].includes(e))}function saleSetTaxFactor(){var e=document.getElementById("saleTaxId"),t=document.querySelectorAll(".jsTaxPercentaje");const a=100*(e.options[e.selectedIndex].getAttribute("data-factor")||0);[...t].forEach(e=>{e.innerHTML=a+"%"}),saleItemCalculate()}function saleSetCurrencySymbol(t){[...document.querySelectorAll(".jsCurrencySymbol")].forEach(e=>{e.innerHTML=t})}function saleSetDefaultValues(){const t=document.getElementById("saleDocumentTypeId");t.addEventListener("change",e=>{saleSetDefaultPdfSize(t),saleSetDefaultIdentityDocumentId(t),saleSetWareHouses(t),saleItemCalculate()}),saleSetDefaultPdfSize(t),saleSetDefaultIdentityDocumentId(t),saleSetWareHouses(t),saleSetOperationTypeValues(),setDefaultCustomer()}function setDefaultCustomer(){defaultCustomer&&"id"in defaultCustomer&&(document.getElementById("saleIdentityDocumentId").value=defaultCustomer.identity_document_id,document.getElementById("saleDocumentNumber").value=defaultCustomer.document_number,document.getElementById("saleSocialReason").value=defaultCustomer.social_reason,document.getElementById("saleFiscalAddress").value=defaultCustomer.fiscal_address,document.getElementById("saleEmail").value=defaultCustomer.email,document.getElementById("salePhone").value=defaultCustomer.telephone,document.getElementById("saleCustomerId").value=defaultCustomer.id,document.getElementById("saleCustomerDocumentNumber").value=defaultCustomer.document_number)}function saleSetDefaultPdfSize(e){var t=document.getElementById("salePdfFormat"),e=e.options[e.selectedIndex]?.getAttribute("data-pdfsize");e&&(t.value=e)}function saleSetDefaultIdentityDocumentId(e){var t=document.getElementById("saleIdentityDocumentId");switch(e.value){case"1":t.value="1";break;case"2":t.value="3";break;case"3":t.value="1"}}function saleSetWareHouses(e){const t=parseInt(e.value)||0,a=document.getElementById("saleSerie"),n=document.getElementById("saleReferenceSerie").value;let l=[];[1,2,3].includes(t)?l=wareHouseSeries.filter(e=>e.document_type_id==t):[4,5].includes(t)&&(l=wareHouseSeries.filter(e=>e.document_type_id==t&&e.serie.substring(0,1)===n.substring(0,1))),a.innerHTML="",l.forEach(e=>{a.insertAdjacentHTML("beforeend",`<option value="${e.serie}">${e.serie}</option>`)})}function saleNewSubmit(){if(pSaleValidator.validate()){let _=(new Date).getFullYear();var e=document.getElementById("saleTaxId"),t={},e=(t.id=document.getElementById("saleId").value||null,t.dateOfIssue=document.getElementById("saleDateOfIssue").value,t.dateOfDue=document.getElementById("saleDateOfDue").value,t.creditDebitTypeId=document.getElementById("saleCreditDebitTypeId").value||null,t.referenceSerie=document.getElementById("saleReferenceSerie").value||"",t.changeType="",t.vehiclePlate=document.getElementById("saleVehiclePlate").value,t.purchaseOrder=document.getElementById("salePurchaseOrder").value,t.pdfFormat=document.getElementById("salePdfFormat")?.value??"TICKET",t.guide=document.getElementById("saleGuide").value,t.observation=document.getElementById("saleObservation").value,t.documentNumber=document.getElementById("saleDocumentNumber").value,t.socialReason=document.getElementById("saleSocialReason").value,t.fiscalAddress=document.getElementById("saleFiscalAddress").value,t.email=document.getElementById("saleEmail").value,t.phone=document.getElementById("salePhone").value,t.emailSend=!0,t.phoneSend=!0,t.customerId=document.getElementById("saleCustomerId").value,t.identityDocumentId=document.getElementById("saleIdentityDocumentId").value,t.totalFree=document.getElementById("saleTotalFree").value,t.totalExportation=document.getElementById("saleTotalExportation").value,t.totalDiscount=document.getElementById("saleTotalDiscount").value,t.totalExonerated=document.getElementById("saleTotalExonerated").value,t.totalUnaffected=document.getElementById("saleTotalUnaffected").value,t.totalTaxed=document.getElementById("saleTotalTaxed").value,t.totalIgv=document.getElementById("saleTotalIgv").value,t.totalCharge=document.getElementById("saleTotalCharge").value||0,t.totalValue=document.getElementById("saleTotalValue").value,t.totalPlasticBagTax=document.getElementById("saleTotalPlasticBagTax").value,t.total=document.getElementById("saleTotal").value,t.documentTypeId=document.getElementById("saleDocumentTypeId").value,t.serie=document.getElementById("saleSerie").value,t.currencyId=document.getElementById("saleCurrencyId").value,t.operationTypeId=document.getElementById("saleOperationTypeId").value,t.incomeWalletCoin=document.getElementById("saleIncomeWalletCoin").innerHTML||0,t.expenseWalletCoin=document.getElementById("saleExpenseWalletCoin").value,t.globalDiscount=document.getElementById("saleTotalGlobalDiscount").value,t.taxFactor=e.options[e.selectedIndex].getAttribute("data-factor"),t.includeTax=operability.sale_items_with_taxes,t.detractionEnabled=document.getElementById("saleDetractionContainerSwitch").checked,t.detractionTypeCat54Id=document.getElementById("saleDetractionTypeCat54Id").value,t.detractionFactor=document.getElementById("saleDetractionFactor").value,t.detractionOriginLocationId=document.getElementById("saleDetractionOriginLocationId").value,t.detractionOriginAddress=document.getElementById("saleDetractionOriginAddress").value,t.detractionArrivalLocationId=document.getElementById("saleDetractionArrivalLocationId").value,t.detractionArrivalAddress=document.getElementById("saleDetractionArrivalAddress").value,t.detractionReferralValue=document.getElementById("saleDetractionReferralValue").value,t.detractionEffectiveLoad=document.getElementById("saleDetractionEffectiveLoad").value,t.detractionUsefulLoad=document.getElementById("saleDetractionUsefulLoad").value,t.detractionTravelDetail=document.getElementById("saleDetractionTravelDetail").value,t.detractionBoatRegistration=document.getElementById("saleDetractionBoatRegistration").value,t.detractionBoatName=document.getElementById("saleDetractionBoatName").value,t.detractionSpeciesKind=document.getElementById("saleDetractionSpeciesKind").value,t.detractionDeliveryAddress=document.getElementById("saleDetractionDeliveryAddress").value,t.detractionQuantity=document.getElementById("saleDetractionQuantity").value,t.detractionDeliveryDate=document.getElementById("saleDetractionDeliveryDate").value,t.perceptionTypeCat22Id=document.getElementById("salePerceptionTypeCat22Id").value||null,t.guideTransferTypeCat20Id=document.getElementById("saleGuideTransferTypeCat20Id").value,t.guideTransportTypeCat18Id=document.getElementById("saleGuideTransportTypeCat18Id").value,t.guideTransferStartDate=document.getElementById("saleGuideTransferStartDate").value,t.guideTotalGrossWeight=document.getElementById("saleGuideTotalGrossWeight").value,t.guideCarrierIdentityDocumentTypeId=document.getElementById("saleGuideCarrierIdentityDocumentTypeId").value,t.guideCarrierDocumentNumber=document.getElementById("saleGuideCarrierDocumentNumber").value,t.guideCarrierDenomination=document.getElementById("saleGuideCarrierDenomination").value,t.guideCarrierPlateNumber=document.getElementById("saleGuideCarrierPlateNumber").value,t.guideDriverIdentityDocumentTypeId=document.getElementById("saleGuideDriverIdentityDocumentTypeId").value,t.guideDriverDocumentNumber=document.getElementById("saleGuideDriverDocumentNumber").value,t.guideDriverFullName=document.getElementById("saleGuideDriverFullName").value,t.guideOriginLocationId=document.getElementById("saleGuideOriginLocationId").value,t.guideOriginAddress=document.getElementById("saleGuideOriginAddress").value,t.guideDeliveryLocationId=document.getElementById("saleGuideDeliveryLocationId").value,t.guideDeliveryAddress=document.getElementById("saleGuideDeliveryAddress").value,t.itinerantLocationId=document.getElementById("saleItinerantLocationId").value||null,t.itinerantAddress=document.getElementById("saleItinerantAddress").value,t.itinerantUrbanization=document.getElementById("saleItinerantUrbanization").value,t.saleItems=[],document.getElementById("saleItemTableBody"));t.saleItems=[...e.children].map((e,t)=>{var a=e.id.split("_")[1],n=e.dataset.controlled,e=JSON.parse(e.dataset.lots||[]),l=document.getElementById("product_unit_price_"+a).value,o=document.getElementById("product_affectation_igv_type_id_"+a).value,d=document.getElementById("product_icbper_"+a).checked,i=document.getElementById("product_quantity_"+a).value,s=document.getElementById("product_discount_"+a).value,r=document.getElementById("product_unit_value_"+a).value,c=document.getElementById("product_total_value_"+a).value,u=document.getElementById("product_igv_"+a).value,m=document.getElementById("product_total_base_igv_"+a).value,p=document.getElementById("product_total_"+a).value,y=document.getElementById("product_product_code_"+a).value,g=document.getElementById("product_sale_unit_measure_id_"+a).value;let v=document.getElementById("product_description_"+a).innerHTML;var I=document.getElementById("product_description_aditional_"+a).value,E=document.getElementById("product_lot_"+a).value,S=document.getElementById("product_recipe_"+a).value,I=(0<I.trim().length&&(v+=" "+I),i=parseFloat(i),d?i*(2022===_?.4:.5):0);return{controlled:n,productCode:y,description:v,quantity:i,unitValue:r,unitPrice:l,discount:s,charge:0,affectationIgvTypeId:o,totalBaseIgv:m,igv:u,totalValue:c,total:p,plasticBagTax:I,unitMeasureId:g,productId:1==n?a:null,lot:E,recipe:S,lots:e}}),saleValidateProcess(t)&&saleShowSalePaymentModal(t)}else dynamicFormSubmitInvalidMessage()}function saleValidateProcess(e){return 0==e.saleItems.lenght?(SnModal.warning({title:"ALERTA USUARIO",content:"Ingrese al menos un producto en los detalles"}),!1):0<=e.total||(SnModal.warning({title:"ALERTA USUARIO",content:"El total no puede ser menor que 0"}),!1)}function searchProductByCode(e){SnLoadingState(!0,"jsAction"),RequestApi.fetch("/admin/maintenanceProduct/barCodeSearch",{method:"POST",body:{barCode:e}}).then(e=>{e.success?e.result.product?(SnMessage.success({content:"Producto encontrado"}),lotSaleProcessPrepareToInsert(e.result.product,e.result.lots)):SnMessage.warning({content:"No se encontró ningún producto"}):dynamicResponseErrorModalMessage(e)}).finally(e=>{SnLoadingState(!1,"jsAction")})}function saleAddItem(d,e=!0){var t=document.getElementById("saleItemTableBody"),a=document.getElementById("product_"+d.id),n=1==operability.sale_items_with_taxes,l=[{description:"Precio 1",price:d?.sale_price_1,whole:1}];0<d?.sale_price_2&&l.push({description:"Precio 2",price:d?.sale_price_2,whole:d?.whole_sale_2}),0<d?.sale_price_3&&l.push({description:"Precio 3",price:d?.sale_price_3,whole:d?.whole_sale_3});let o="";affectationIgvTypes.forEach(e=>{o+=`<option value="${e.id}">${e.description}</option>`}),a?document.getElementById("product_quantity_"+d.id).value=d.quantity||1:(a=0==operability.lot_automatic_exit&&e&&1==d.lot,t.insertAdjacentHTML("beforeend",`<tr id="product_${d.id}" data-controlled="${e?1:0}" data-lots="[]">
                                                            <td>
                                                                <input id="product_quantity_${d.id}" min="0" ${a?'style="width: 70px; background: transparent; border-color: transparent;" readonly title="preciona doble click para cambiar la cantidad"':'style="width: 80px"'} type="number" class="SnForm-control" value="${parseFloat(d.quantity||1)}">
                                                                <input id="product_product_code_${d.id}" type="hidden" class="SnForm-control" value="${d.product_catalog_code}">
                                                                <input id="product_sale_unit_measure_id_${d.id}" type="hidden" class="SnForm-control" value="${d.sale_unit_measure_id}">
                                                                <input id="product_lot_${d.id}" type="hidden" class="SnForm-control" value="${d.lot}">
                                                                <input id="product_recipe_${d.id}" type="hidden" class="SnForm-control" value="${d.recipe}">
                                                            </td>
                                                            <td id="product_description_${d.id}">${d.description}</td>
                                                            <td>
                                                                <input id="product_description_aditional_${d.id}" type="text" class="SnForm-control" style="min-width: 80px">
                                                            </td>
                                                            <td id="product_lot_check_${d.id}">${1==d.lot?'<i class="fas fa-cubes" title="Manejo por lotes"></i>':e?"":'<i class="fas fa-bolt" title="Artículo rapido"></i>'}</td>
                                                            <td id="product_stock_${d.id}">${parseFloat(d.stock)} ${d.sale_unit_measure_id_code}</td>
                                                            <td>
                                                                <div class="SnControl-wrapper ${n?"":"hidden"}">
                                                                    ${1<l.length&&n?`<div class="SnControl-prefix" id="product_change_price_${d.id}" title="Otros precios"><i class="fa-solid fa-arrow-right-arrow-left"></i></div>`:""}
                                                                    <input id="product_unit_price_${d.id}" min="0" type="${n?"number":"hidden"}" class="SnForm-control SnControl" value="${d.sale_price_1}" data-prices='${JSON.stringify(l)}'>
                                                                </div>
                                                                <div class="SnControl-wrapper ${n?"hidden":""}">
                                                                    ${1<l.length&&!n?`<div class="SnControl-prefix" id="product_change_price_${d.id}" title="Otros precios"><i class="fa-solid fa-arrow-right-arrow-left"></i></div>`:""}
                                                                    <input id="product_unit_value_${d.id}" min="0" type="${n?"hidden":"number"}" class="SnForm-control SnControl" value="${d.sale_price_1}" data-prices='${JSON.stringify(l)}'>
                                                                </div>
                                                            </td>
                                                            <td class="${n?"hidden":""}">
                                                              <input id="product_total_value_${d.id}" min="0" type="hidden" class="SnForm-control" value="0">
                                                              <span id="product_total_value_html_${d.id}"></span>
                                                            </td>
                                                            <td class="${n?"":"hidden"}">
                                                              <input id="product_total_${d.id}" min="0" type="hidden" class="SnForm-control" value="0">
                                                              <span id="product_total_html_${d.id}"></span>
                                                            </td>
                                                            <td class="SnTable-action">
                                                                <button id="product_remove_${d.id}" class="SnBtn icon radio" type="button"><i class="fas fa-trash"></i></button>
                                                                <button id="product_options_${d.id}" class="SnBtn icon radio SnMl-2" title="Mas opciones" type="button"><i class="fa-solid fa-ellipsis-vertical"></i></button>

                                                                <div class="SnModal-wrapper" data-modal="saleItemModal_${d.id}" data-maskclose="true" onclick="saleItemCloseModal(${d.id})">
                                                                  <div class="SnModal">
                                                                    <div class="SnModal-close" data-modalclose="saleItemModal_${d.id}" onclick="saleItemCloseModal(${d.id})">
                                                                      <i class="fas fa-times"></i>
                                                                    </div>
                                                                    <div class="SnModal-header"><i class="fas fa-list-ul SnMr-2"></i>Producto item</div>
                                                                    <div class="SnModal-body">
                                                                      <div class="SnForm-item inner">
                                                                        <label for="product_affectation_igv_type_id_${d.id}" class="SnForm-label">Tipo de afectación</label>
                                                                        <select id="product_affectation_igv_type_id_${d.id}" class="SnForm-control">${o}</select>
                                                                      </div>
                                                                      <div class="SnForm-item inner">
                                                                        <label for="product_total_base_igv_${d.id}" class="SnForm-label">Base imponible IGV</label>
                                                                        <input id="product_total_base_igv_${d.id}" type="number" readonly class="SnForm-control" value="0">
                                                                      </div>
                                                                      <div class="SnForm-item inner">
                                                                        <label for="product_igv_${d.id}" class="SnForm-label">Igv</label>
                                                                        <input id="product_igv_${d.id}" type="number" readonly class="SnForm-control" value="0">
                                                                      </div>
                                                                      <div class="SnForm-item inner">
                                                                        <label for="product_discount_${d.id}" class="SnForm-label">Descuento por Item o Línea (aplica al Subtotal)</label>
                                                                        <input id="product_discount_${d.id}" min="0" type="number" class="SnForm-control" value="0" title="Descuento por Item o Línea (aplica al Subtotal)">
                                                                      </div>
                                                                      <div>
                                                                        <input type="checkbox" id="product_icbper_${d.id}">
                                                                        <label for="product_icbper_${d.id}" class="SnForm-label">ICBPER</label>
                                                                      </div>
                                                                      <div class="SnBtn radio primary block lg SnMt-3" onclick="saleItemCloseModal(${d.id})"><i class="fa-solid fa-check SnMr-2"></i>Aplicar</div>
                                                                    </div>
                                                                  </div>
                                                                </div>

                                                            </td>
                                                        </tr>`),0<d.affectation_igv_type_id&&(document.getElementById("product_affectation_igv_type_id_"+d.id).value=d.affectation_igv_type_id),a?document.getElementById("product_quantity_"+d.id).addEventListener("dblclick",e=>{var t=document.getElementById("product_lot_"+d.id).value,a=document.getElementById("product_quantity_"+d.id).value,n=document.getElementById("product_description_"+d.id).innerHTML,l=document.getElementById("product_"+d.id).dataset.lots,o=document.getElementById("product_"+d.id).dataset.controlled;processQuantityChange(a,!1,{quantity:a,lot:t,id:d.id,description:n,controlled:o},JSON.parse(l||[]))}):document.getElementById("product_quantity_"+d.id).addEventListener("change",e=>{saleItemChangePrice(d.id),saleItemCalculate()}),(t=document.getElementById("product_change_price_"+d.id))&&t.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation(),openItemChangePrice(d.id)}),document.getElementById("product_discount_"+d.id).addEventListener("change",e=>{saleItemCalculate()}),document.getElementById("product_unit_price_"+d.id).addEventListener("change",e=>{saleItemCalculate()}),document.getElementById("product_unit_value_"+d.id).addEventListener("change",e=>{saleItemCalculate()}),document.getElementById("product_affectation_igv_type_id_"+d.id).addEventListener("change",e=>{saleItemCalculate()}),document.getElementById("product_icbper_"+d.id).addEventListener("change",e=>{saleItemCalculate()}),document.getElementById("product_remove_"+d.id).addEventListener("click",e=>{saleItemRemove(d.id)}),document.getElementById("product_options_"+d.id).addEventListener("click",e=>{SnModal.open("saleItemModal_"+d.id)})),saleItemCalculate()}function saleItemRemove(e){document.getElementById("product_"+e).remove(),saleItemCalculate()}function saleItemCloseModal(e){SnModal.close("saleItemModal_"+e)}function saleItemChangePrice(e){var t=1==operability.sale_items_with_taxes,a=document.getElementById("product_quantity_"+e),t=t?document.getElementById("product_unit_price_"+e):document.getElementById("product_unit_value_"+e);let n=a.value;e=JSON.parse(t.dataset?.prices||"[]")??[];1<e.length&&(e.sort(function(e,t){return parseFloat(t.whole)-parseFloat(e.whole)}),void 0!==(a=e.find(e=>parseInt(n)>=parseInt(e.whole))))&&(t.value=a.price)}function openItemChangePrice(t){var n=1==operability.sale_items_with_taxes?document.getElementById("product_unit_price_"+t):document.getElementById("product_unit_value_"+t),l=JSON.parse(n.dataset?.prices||"[]")??[];if(1<l.length){l=l.map(e=>`<li class="SnList-item" onclick="saleItemSetPrice(${t},${e.price})">${e.description} minimo(${parseFloat(e.whole)??0}): <strong>${e.price}</strong></li>`).join("");let a=document.getElementById("pricePortal");a||((a=document.createElement("div")).setAttribute("id","pricePortal"),a.classList.add("SnPortal"),document.body.appendChild(a)),a.innerHTML=`<ul class="SnList menu">${l}</ul>`;{l=a;let e=0,t=0;var o=n.getBoundingClientRect(),d=window.pageXOffset||document.documentElement.scrollLeft,i=window.pageYOffset||document.documentElement.scrollTop,s=n.offsetHeight,n=n.offsetWidth,r=l.getBoundingClientRect(),i=o.top+i+s,i=(e=i+r.height<window.innerHeight?i+"px":i-(r.height+s)+"px",o.left+d+n);t=i<r.width?i+"px":i-r.width+"px",l.style.top=e,l.style.left=t}}}function saleItemSetPrice(e,t){(1==operability.sale_items_with_taxes?document.getElementById("product_unit_price_"+e):document.getElementById("product_unit_value_"+e)).value=t}function saleItemCalculate(){let y=1==operability.sale_items_with_taxes;var e=document.getElementById("saleTaxId");let g=e.options[e.selectedIndex].getAttribute("data-factor")||0,v=(g=parseFloat(g),"1"!=document.getElementById("saleDocumentTypeId").value);[...document.getElementById("saleItemTableBody").children].map((e,t)=>{e=e.id.split("_")[1];let a=document.getElementById("product_unit_price_"+e).value||0;var n=document.getElementById("product_affectation_igv_type_id_"+e),l=document.getElementById("product_icbper_"+e),o=document.getElementById("product_total_base_igv_"+e),d=document.getElementById("product_igv_"+e),i=document.getElementById("product_quantity_"+e).value||0,s=document.getElementById("product_discount_"+e).value||0;let r=document.getElementById("product_unit_value_"+e).value||0;v?(n.parentElement.classList.remove("hidden"),l.parentElement.classList.remove("hidden"),o.parentElement.classList.remove("hidden"),d.parentElement.classList.remove("hidden")):(n.parentElement.classList.add("hidden"),l.parentElement.classList.add("hidden"),o.parentElement.classList.add("hidden"),d.parentElement.classList.add("hidden"));l=n.value;a=parseFloat(a),l=parseInt(l),i=parseFloat(i),s=parseFloat(s),r=parseFloat(r);let c,u,m,p;v?(c=(m=y?1===l?(r=a/(1+g),p=i*r-s,(u=p)*g):(r=a,p=i*r-s,u=p,0):1===l?(a=r*(1+g),p=i*r-s,(u=p)*g):(a=r,p=i*r-s,u=p,0),p+m),document.getElementById("product_unit_price_"+e).value=a,document.getElementById("product_unit_value_"+e).value=r):(p=i*(y?a:r)-s,u=p,m=0,c=p+m),document.getElementById("product_total_base_igv_"+e).value=u,document.getElementById("product_igv_"+e).value=m,document.getElementById("product_total_value_"+e).value=p,document.getElementById("product_total_value_html_"+e).innerHTML=formatNumber(p),document.getElementById("product_total_"+e).value=c,document.getElementById("product_total_html_"+e).innerHTML=formatNumber(c)}),saleTotalCalculate()}function saleGetGlobalDiscount(e){var t=document.getElementById("saleGlobalDiscountPercentage"),a=document.getElementById("saleGlobalDiscountAmount"),n=parseFloat(t.value||0),l=parseFloat(a.value||0);let o=0,d=0;return document.getElementById("saleGlobalDiscountSwitch").checked?(d=0<n?(e*(o=parseFloat(n)/100)).toFixed(2):o=0,a.value=d):(0<l?(d=parseFloat(l),o=d/e):(o=0,d=0),t.value=(100*o).toFixed(2)),{discountFactor:o,discountAmount:d}}function saleTotalCalculate(){var e=document.getElementById("saleTaxId"),t=document.getElementById("saleExpenseWalletCoin").value||0,a=1!=document.getElementById("saleDocumentTypeId").value,e=e.options[e.selectedIndex].getAttribute("data-factor")||0,e=parseFloat(e),t=parseFloat(t);let s=0,r=0,c=0,u=0,m=0,p=0,y=0,g=0,v=0,I=0,n=0,l=0;[...document.getElementById("saleItemTableBody").children].map((e,t)=>{var e=e.id.split("_")[1],a=document.getElementById("product_affectation_igv_type_id_"+e).value,n=document.getElementById("product_icbper_"+e).checked,l=document.getElementById("product_quantity_"+e).value,o=document.getElementById("product_discount_"+e).value,d=document.getElementById("product_total_value_"+e).value,e=document.getElementById("product_igv_"+e).value,a=parseInt(a),l=parseFloat(l),o=parseFloat(o),d=parseFloat(d),e=parseFloat(e),i=(g+=n?.5*l:0,d+e);switch(a){case 1:s+=i,m+=d;break;case 8:s+=i,r+=d;break;case 9:s+=i,c+=d;break;case 2:case 3:case 4:case 5:case 6:case 7:case 10:case 11:case 12:case 13:case 14:case 15:y+=d;break;case 16:s+=i,u+=d}p+=o,I+=l,v++});var o=saleGetGlobalDiscount(s);let d=0,i=0,E=0,S=0;0<o.discountFactor&&(d=r*o.discountFactor,i=c*o.discountFactor,E=u*o.discountFactor,S=m*o.discountFactor),1==operability.wallet&&0<t&&(d=0<r?d+t:d,i=0<c?i+t:i,E=0<u?E+t:E,S=0<m?S+t:S),_=d+i+E+S;var _,f=fixedNumber(y),h=fixedNumber(r-d),B=fixedNumber(c-i),b=fixedNumber(u-E),T=fixedNumber(m-S),P=fixedNumber(_+p),e=fixedNumber(a?(m-S)*e:0),M=parseFloat(document.getElementById("saleTotalCharge").value||0),C=B+T+h+b,D=C+e+M+g;operability.wallet&&(n=D*operability.wallet_percentaje/100,l=n*operability.wallet_point),console.log({globalDiscountFactor:o,exoneratedDiscount:d,unaffectedDiscount:i,exportDiscount:E,taxedDiscount:S,totalFree:f,totalExonerated:h,totalUnaffected:B,totalExport:b,totalTaxed:T,totalDiscount:P,totalIgv:e,saleTotalCharge:M,totalValue:C,total:D},"_PERCER_"),document.getElementById("summaryTotalLines").innerHTML=formatNumber(v,1),document.getElementById("summaryTotalCuantity").innerHTML=formatNumber(I),document.getElementById("summaryTotalWeight").innerHTML=0,operability.wallet&&(document.getElementById("saleIncomeWalletCoin").innerHTML=n,document.getElementById("summaryTotalWalletPoint").innerHTML=formatNumber(l)),updateTotalValueElement("saleSubTotal",s,!0),updateTotalValueElement("saleTotalFree",f,f&&a),updateTotalValueElement("saleTotalExportation",b,b&&a),updateTotalValueElement("saleTotalGlobalDiscount",_,0<_),updateTotalValueElement("saleTotalItemDiscount",p,0<p),updateTotalValueElement("saleExpenseWalletCoin",t,0<t),updateTotalValueElement("saleTotalDiscount",P,0<P),updateTotalValueElement("saleTotalExonerated",h,0<h),updateTotalValueElement("saleTotalUnaffected",B,0<B&&a),updateTotalValueElement("saleTotalTaxed",T,0<T&&a),updateTotalValueElement("saleTotalIgv",e,0<e&&a),document.getElementById("saleTotalValue").value=C.toFixed(2),updateTotalValueElement("saleTotalPlasticBagTax",g,0<g),updateTotalValueElement("saleTotal",D,!0),document.getElementById("saleTotalHelpHtml").innerHTML=formatNumber(D)}function updateTotalValueElement(e,t,a){document.getElementById(e+"Container").classList.toggle("hidden",!a),document.getElementById(e).value=parseFloat(t).toFixed(2),document.getElementById(e+"Html").innerHTML=formatNumber(t)}function newSaleClear(){dynamicClearForm(pSaleValidator,"newSaleForm","saleSearchProductCode","saleItemTableBody"),dynamicClearForm(pSalePaymentValidator,"salePaymentModalForm"),document.getElementById("saleSubTotalHtml").innerHTML=0,document.getElementById("saleTotalFreeHtml").innerHTML=0,document.getElementById("saleTotalExportationHtml").innerHTML=0,document.getElementById("saleTotalDiscountHtml").innerHTML=0,document.getElementById("saleTotalExoneratedHtml").innerHTML=0,document.getElementById("saleTotalUnaffectedHtml").innerHTML=0,document.getElementById("saleTotalTaxedHtml").innerHTML=0,document.getElementById("saleTotalIgvHtml").innerHTML=0,document.getElementById("saleTotalChargeHtml").innerHTML=0,document.getElementById("saleTotalValueHtml").innerHTML=0,document.getElementById("saleTotalPlasticBagTaxHtml").innerHTML=0,document.getElementById("saleTotalHtml").innerHTML=0,document.getElementById("saleTaxpayerState").innerHTML="",document.getElementById("saleTaxpayerCondition").innerHTML="",document.getElementById("saleTotal").value=0,document.getElementById("saleCustomerId").value=0,document.getElementById("saleCustomerDocumentNumber").value="",document.getElementById("saleExpenseWalletCoinHtml").innerHTML=0,document.getElementById("saleTotalGlobalDiscountHtml").innerHTML=0,document.getElementById("saleIncomeWalletCoin").innerHTML=0,document.getElementById("summaryTotalWalletPoint").innerHTML=0,pSalePaymentMethod?.clearValues(),saleSetDefaultValues()}function saleNewList(e,t){window.location.href=URL_PATH+"/admin/"+t}document.addEventListener("DOMContentLoaded",()=>{pSaleValidator=dynamicLoadFormValidate(pSaleValidator,"newSaleForm"),pSalePaymentValidator=dynamicLoadFormValidate(pSalePaymentValidator,"salePaymentModalForm"),pUncontrolledProductValidator=dynamicLoadFormValidate(pUncontrolledProductValidator,"uncontrolledProductModalForm"),pMovementValidator=dynamicLoadFormValidate(pMovementValidator,"movementModalForm"),pProcessQuantityValidator=dynamicLoadFormValidate(pProcessQuantityValidator,"processQuantityForm"),pWalletValidator=dynamicLoadFormValidate(pWalletValidator,"walletModalForm");var e=document.getElementById("newSaleForm");e.addEventListener("submit",function(e){e.preventDefault(),saleNewSubmit()}),e.addEventListener("reset",function(e){newSaleClear()}),document.getElementById("salePaymentModalForm").addEventListener("submit",function(e){e.preventDefault(),salePaymentModalSubmit()}),document.getElementById("uncontrolledProductModalForm").addEventListener("submit",function(e){e.preventDefault(),uncontrolledProductModalSubmit()}),document.getElementById("walletModalForm").addEventListener("submit",function(e){e.preventDefault(),walletModalSubmit()});const t=document.getElementById("saleSearchProductCode"),a=(t.addEventListener("keypress",function(e){"Enter"===e.key&&e.preventDefault()}),t.addEventListener("keyup",function(e){"Enter"===e.key&&(e.preventDefault(),searchProductByCode(e.target.value),t.value="")}),SnLiveList({elem:"#saleSearchProductDescription",data:(e,a)=>{e.length<4?a("Escriba almenos 4 caracteres"):(a("Cargando..."),SnLoadingState(!0,"jsAction"),RequestApi.fetch("/admin/maintenanceProduct/descriptionSearch",{method:"POST",body:{description:e}}).then(e=>{var t;e.success?(t=e.result.map(e=>{var t=[{price:parseFloat(e.sale_price_1??0),whole:1},{price:parseFloat(e.sale_price_2??0),whole:parseFloat(e.whole_sale_2??0)},{price:parseFloat(e.sale_price_3??0),whole:parseFloat(e.whole_sale_3??0)}].filter(e=>0<e.price).map(e=>`(${e.whole}) <strong>${e.price}</strong>`).join(" , ");return{...e,text:e.description+`</br><i>${t}</i>`,value:e.id}}),a(t)):a(e.message)}).finally(e=>{SnLoadingState(!1,"jsAction")}))},onSelect:(e,t)=>{lotSaleProcessPrepareToInsert(t,t.lots),document.getElementById("saleSearchProductDescription").value="",document.getElementById("saleSearchProductDescription").focus()}}),document.getElementById("saleDocumentNumber")),n=(a.addEventListener("keypress",function(e){"Enter"===e.key&&e.preventDefault()}),a.addEventListener("keyup",function(e){"Enter"===e.key&&(e.preventDefault(),getIdentityDocumentNumber(e.target.value,a))}),a.addEventListener("change",function(e){e.preventDefault(),validateChangeDocumentNumber(e.target.value)}),document.getElementById("saleOperationTypeId").addEventListener("change",function(e){e.preventDefault(),saleSetOperationTypeValues()}),saleSetOperationTypeValues(),document.getElementById("saleCurrencyId")),l=(n.addEventListener("change",function(e){e.preventDefault(),saleSetCurrencySymbol(n.options[n.selectedIndex].getAttribute("data-symbol")),saleTotalCalculate()}),saleSetCurrencySymbol(n.options[n.selectedIndex].getAttribute("data-symbol")),document.getElementById("saleTaxId").addEventListener("change",function(e){e.preventDefault(),saleSetTaxFactor()}),saleSetTaxFactor(),document.getElementById("saleGlobalDiscountPercentage").addEventListener("input",e=>{e.preventDefault(),saleTotalCalculate()}),document.getElementById("saleGlobalDiscountAmount").addEventListener("input",e=>{e.preventDefault(),saleTotalCalculate()}),document.getElementById("saleGlobalDiscountSwitch")),o=(l.addEventListener("change",()=>{(l.checked?(document.getElementById("saleGlobalDiscountSwitchLabel").innerHTML="Descuento en %",document.getElementById("saleGlobalDiscountPercentageRow").classList.remove("hidden"),document.getElementById("saleGlobalDiscountAmountRow")):(document.getElementById("saleGlobalDiscountSwitchLabel").innerHTML="Desc. por Monto",document.getElementById("saleGlobalDiscountAmountRow").classList.remove("hidden"),document.getElementById("saleGlobalDiscountPercentageRow"))).classList.add("hidden")}),document.getElementById("saleTotalCharge").addEventListener("input",()=>{saleTotalCalculate()}),document.getElementById("movementModalForm").addEventListener("submit",function(e){e.preventDefault(),movementModalSubmit()}),document.getElementById("processQuantityForm"));o.addEventListener("submit",function(e){e.preventDefault(),processQuantityFormSubmit(o)}),saleSetDefaultValues(),saleItemData&&0<saleItemData.length&&saleItemData.forEach(e=>{saleAddItem(e,1==e.is_controlled)}),document.getElementById("saleDetractionContainerSwitch").addEventListener("change",()=>{saleSetDetractionState()}),saleSetDetractionState(),slimSaleDetractionOriginLocationId=new SlimSelect({select:"#saleDetractionOriginLocationId",settings:{searchingText:"Buscando...",allowDeselect:!0},events:{search:(e,t)=>new Promise((a,n)=>{if(e.length<2)return n("Escriba almenos 2 caracteres");RequestApi.fetch("/page/searchLocation",{method:"POST",body:{search:e}}).then(e=>{var t;e.success?(t=e.result.map(e=>({text:e.description,value:e.id})),a(t)):n(e.message)}).catch(e=>{n(e)})})}}),slimSaleDetractionArrivalLocationId=new SlimSelect({select:"#saleDetractionArrivalLocationId",settings:{searchingText:"Buscando...",allowDeselect:!0},events:{search:(e,t)=>new Promise((a,n)=>{if(e.length<2)return n("Escriba almenos 2 caracteres");RequestApi.fetch("/page/searchLocation",{method:"POST",body:{search:e}}).then(e=>{var t;e.success?(t=e.result.map(e=>({text:e.description,value:e.id})),a(t)):n(e.message)}).catch(e=>{n(e)})})}}),document.getElementById("salePerceptionContainerSwitch").addEventListener("change",()=>{saleSetPerceptionState()}),saleSetPerceptionState(),slimSaleGuideOriginLocationId=new SlimSelect({select:"#saleGuideOriginLocationId",settings:{searchingText:"Buscando...",allowDeselect:!0},events:{search:(e,t)=>new Promise((a,n)=>{if(e.length<2)return n("Escriba almenos 2 caracteres");RequestApi.fetch("/page/searchLocation",{method:"POST",body:{search:e}}).then(e=>{var t;e.success?(t=e.result.map(e=>({text:e.description,value:e.id})),a(t)):n(e.message)}).catch(e=>{n(e)})})}}),slimSaleGuideDeliveryLocationId=new SlimSelect({select:"#saleGuideDeliveryLocationId",settings:{searchingText:"Buscando...",allowDeselect:!0},events:{search:(e,t)=>new Promise((a,n)=>{if(e.length<2)return n("Escriba almenos 2 caracteres");RequestApi.fetch("/page/searchLocation",{method:"POST",body:{search:e}}).then(e=>{var t;e.success?(t=e.result.map(e=>({text:e.description,value:e.id})),a(t)):n(e.message)}).catch(e=>{n(e)})})}}),slimSaleItinerantLocationId=new SlimSelect({select:"#saleItinerantLocationId",settings:{searchingText:"Buscando...",allowDeselect:!0},events:{search:(e,t)=>new Promise((a,n)=>{if(e.length<2)return n("Escriba almenos 2 caracteres");RequestApi.fetch("/page/searchLocation",{method:"POST",body:{search:e}}).then(e=>{var t;e.success?(t=e.result.map(e=>({text:e.description,value:e.id})),a(t)):n(e.message)}).catch(e=>{n(e)})})}}),dynamicViewKeyboardListeners(screenName,appMenuActions),document.body.addEventListener("click",()=>{var e=document.getElementById("pricePortal");null!==e&&e.remove()}),window.addEventListener("resize",()=>{var e=document.getElementById("pricePortal");null!==e&&e.remove()})});class SnPayment{constructor(e){this.options=e,this.paymentMethodFocus=0,this.total=0,this.paymentMethods=[],this.creditNumberCuotes=0,this.operability={},this.walletCoin=0,this.setDefaultValues(),this.renderBase()}setDefaultValues(){this.options.paymentMethods?this.paymentMethods=this.options.paymentMethods:this.paymentMethods=[{id:1,description:"Efectivo",total:0,reference:"",dateOfDue:"",icon:"fas fa-money-bill-wave"},{id:2,description:"Tarjeta",total:0,reference:"",dateOfDue:"",icon:"fas fa-credit-card"},{id:3,description:"Vale",total:0,reference:"",dateOfDue:"",icon:"fa-solid fa-ticket"},{id:5,description:"Banco",total:0,reference:"",dateOfDue:"",icon:"fas fa-university"},{id:6,description:"App",total:0,reference:"",dateOfDue:"",icon:"fas fa-mobile-alt"}],this.operability=this.options.operability??{}}clearValues(){this.paymentMethods.forEach(e=>{document.getElementById("snPaymentMethod"+e.id).value=0}),document.getElementById("salePaymentTotalTop").innerHTML="",document.getElementById("salePaymentTotalDescriptionTop").innerHTML="",document.getElementById("snPaymentMethodReference").value=""}setTotal(e,t=0){this.total=parseFloat(e),this.walletCoin=parseFloat(t),this.clearValues(),document.getElementById("salePaymentTotalTop").innerHTML=formatNumber(this.total),document.getElementById("salePaymentTotalDescriptionTop").innerHTML=numToWordCurrency(parseFloat(this.total).toFixed(2)),this.initPayment(!1)}getValues(){let a=[],n=0;[...document.getElementById("snPaymentCreditTableBody").children].forEach(e=>{var t={};t.cuote=document.getElementById("snPaymentCreditRowCuote_"+e.dataset.id).value,t.total=document.getElementById("snPaymentCreditRowAmount_"+e.dataset.id).value,t.dateOfDue=document.getElementById("snPaymentCreditRowDateOfDue_"+e.dataset.id).value,t.total=parseFloat(t.total),a.push(t),n+=t.total});var e=document.getElementById("snPaymentTotalTurned").innerHTML,e=parseFloat(e);return{paymentMethods:this.paymentMethods,creditCuotes:a,totalCredit:n,returned:e}}renderBase(){document.getElementById(this.options.elementId).innerHTML='<div class="SnGrid col-gap s-grid-'+Math.ceil(this.paymentMethods.length/2)+` m-grid-${this.paymentMethods.length}">
                                    ${this.paymentMethods.map(e=>`<div class="SnForm-item inner required">
                                                    <label for="snPaymentMethod${e.id}" class="SnForm-label">${e.description}</label>
                                                    <div class="SnControl-wrapper">
                                                        <i class="${e.icon} SnControl-prefix"></i>
                                                        <input type="number" class="SnForm-control sm SnControl" id="snPaymentMethod${e.id}" required value="0">
                                                    </div>
                                                </div>`).join("")}
                                </div>

                                <div class="SnControlGroup">
                                    <div class="SnControlGroup-prepend">
                                        <div class="SnControlGroup-prepend-text">Referencia</div>
                                    </div>
                                    <div class="SnControlGroup-input">
                                        <input class="SnForm-control" type="text" placeholder="Referencia" id="snPaymentMethodReference">
                                    </div>
                                </div>

                                <div style="display: flex;" class="SnMt-2" id="snPaymentWallet">
                                  <div title="Monedas monedero electrónico" style="padding: .2rem; display: flex; align-items: center;">
                                    <i class="fa-solid fa-coins" style="font-size: 1rem;"></i>
                                    <span id="snPaymentWalletCoin"></span>
                                  </div>
                                  <div title="Puntos monedero electrónico" class="SnMl-2" style="padding: .2rem; display: flex; align-items: center;">
                                    <i class="fa-brands fa-product-hunt" style="font-size: 1rem;"></i>
                                    <span id="snPaymentWalletPoint"></span>
                                  </div>
                                </div>

                                <div class="SnDivider"></div>

                                <div class="SnGrid col-gap s-grid-2">
                                    <div class="SalePaymentSummay-left">
                                        <div>
                                          <span>Total, a crédito </span>
                                          <span class="SalePaymentSummay-credit" id="snPaymentTotalCredit">0.00</span>
                                        </div>
                                        <button type="button" class="SnBtn warning SnMt-2" id="snPaymentCreditToggle"><i class="fas fa-plus SnMr-2"></i> Agregar credito</button>
                                    </div>
                                    <div class="SalePaymentSummay-right">
                                        <div>Cambio</div>
                                        <div class="SalePaymentSummay-turned success" id="snPaymentTotalTurned">0.00</div>
                                    </div>
                                </div>

                                <div id="snPaymentCreditContainer" class="hidden">
                                    <div class="SnDivider"><strong>PAGO A CREDITO</strong></div>
                                    <table class="SnTable SnMb-4">
                                        <thead>
                                            <tr>
                                                <th>Cuota</th>
                                                <th>Monto</th>
                                                <th>Fecha vencimiento</th>
                                                <th></th>
                                            </tr>
                                        </thead>
                                        <tbody id="snPaymentCreditTableBody"></tbody>
                                    </table>
                                    <button type="button" class="SnBtn radio block SnMb-5" id="snPaymentCreditAddCuote"><i class="fas fa-plus SnMr-2"></i>Agregar cuota</button>
                                </div>
                                `;const a=document.getElementById("snPaymentMethodReference");var e=document.getElementById("snPaymentCreditToggle");const t=document.getElementById("snPaymentCreditContainer");this.paymentMethods.forEach(t=>{var e=document.getElementById("snPaymentMethod"+t.id);e.addEventListener("input",e=>{e.preventDefault(),this.calculate()}),e.addEventListener("focus",e=>{e.preventDefault(),this.paymentMethodFocus=t.id,a.value=this.getReference(t.id)})}),a.addEventListener("input",e=>{e.preventDefault(),this.setReference(a.value)}),e.addEventListener("click",e=>{e.preventDefault(),this.initPayment(t.classList.contains("hidden"))}),document.getElementById("snPaymentCreditAddCuote").addEventListener("click",e=>{this.addCreditCuote()})}initPayment(e=!1){var t=document.getElementById("snPaymentCreditContainer"),a=document.getElementById("snPaymentCreditToggle"),n=document.getElementById("snPaymentWallet");e?(t.classList.remove("hidden"),a.innerHTML='<i class="fas fa-minus SnMr-2"></i> Quitar credito',this.initPaymentCredit()):(t.classList.add("hidden"),a.innerHTML='<i class="fas fa-plus SnMr-2"></i> Agregar credito',this.initPaymentCash()),1==this.operability.wallet?n.classList.remove("hidden"):n.classList.add("hidden")}initPaymentCash(){this.setDefaultValues();var e=this.paymentMethods[0],e=document.getElementById("snPaymentMethod"+e.id);e.value=this.total.toFixed(2),e.focus(),document.getElementById("snPaymentCreditTableBody").innerHTML="",this.calculate()}initPaymentCredit(){this.paymentMethods.forEach(e=>{document.getElementById("snPaymentMethod"+e.id).value=0}),this.addCreditCuote({amount:this.total})}removeCreditCuote(e){document.getElementById("snPaymentCreditRow_"+e).remove(),0===[...document.getElementById("snPaymentCreditTableBody").children].length?(this.initPaymentCash(),document.getElementById("snPaymentCreditContainer").classList.add("hidden"),document.getElementById("snPaymentCreditToggle").innerHTML='<i class="fas fa-plus SnMr-2"></i> Agregar credito'):this.calculate()}addCreditCuote(t={}){t.cuote=[...document.getElementById("snPaymentCreditTableBody").children].length+1,snPaymentCreditTableBody.insertAdjacentHTML("beforeend",`<tr id="snPaymentCreditRow_${t.cuote}" data-id="${t.cuote}">
                        <td><input type="text" id="snPaymentCreditRowCuote_${t.cuote}" class="SnForm-control" value="${t.cuote}" disabled></td>
                        <td><input type="number" id="snPaymentCreditRowAmount_${t.cuote}" class="SnForm-control" value="${t.amount||0}"></td>
                        <td><input type="date" id="snPaymentCreditRowDateOfDue_${t.cuote}" class="SnForm-control" value="${t.dateOfDue||""}"></td>
                        <td><button type="button" class="SnBtn radio icon" id="snPaymentCreditRowRemove_${t.cuote}"><i class="fas fa-trash-alt"></i></button></td>
                    </tr>`);var e=document.getElementById("snPaymentCreditRowAmount_"+t.cuote);e.addEventListener("input",e=>{this.calculate()}),document.getElementById("snPaymentCreditRowDateOfDue_"+t.cuote).addEventListener("input",e=>{this.calculate()}),document.getElementById("snPaymentCreditRowRemove_"+t.cuote).addEventListener("click",e=>{this.removeCreditCuote(t.cuote)}),e.focus(),this.calculate()}getReference(t){var e=this.paymentMethods.find(e=>e.id===t);return null!=e?e.reference:""}setReference(t){this.paymentMethods=this.paymentMethods.map(e=>e.id===this.paymentMethodFocus?{...e,reference:t}:e)}calculate(){var e=document.getElementById("snPaymentTotalTurned");let n=0,l=[],t=(this.paymentMethods.forEach((t,e)=>{var a=document.getElementById("snPaymentMethod"+t.id),a=parseFloat(a.value||0);if(n+=a,this.paymentMethods[e].total=a,1==this.operability.wallet&&1==this.operability.wallet_payment_method){let e;switch(t.id){case 1:e=parseFloat(this.operability.wallet_cash||0);break;case 2:e=parseFloat(this.operability.wallet_card||0);break;case 3:e=parseFloat(this.operability.wallet_voucher||0);break;case 5:e=parseFloat(this.operability.wallet_bank||0);break;case 6:e=parseFloat(this.operability.wallet_app||0)}l.push({id:t.id,total:a,percentaje:e})}}),0);[...document.getElementById("snPaymentCreditTableBody").children].forEach(e=>{e=document.getElementById("snPaymentCreditRowAmount_"+e.dataset.id);t+=parseFloat(e.value||0)});var a=this.total-n,o=(n+t-this.total).toFixed(2),a=(document.getElementById("snPaymentTotalCredit").innerHTML=(0<a?a:0).toFixed(2),0<=(e.innerHTML=o)?(e.classList.add("success"),e.classList.remove("error")):(e.classList.add("error"),e.classList.remove("success")),l.reduce((e,t)=>0===t.percentaje?e+t.total:0,0));const d=this.walletCoin-a;l=l.map(e=>({...e,evalTotal:e.total/this.total*d}))}}let pSalePaymentCurrentFocus="",pSalePaymentMethod=null;function saleShowSalePaymentModal(e){pSalePrepare=e,walletCoin=document.getElementById("saleIncomeWalletCoin").innerHTML||0,(pSalePaymentMethod=null===pSalePaymentMethod?new SnPayment({elementId:"salePaymentMethodsWrapper",operability:operability}):pSalePaymentMethod).setTotal(e.total,walletCoin),SnModal.open("salePaymentModal")}function salePaymentModalSubmit(){if(pSalePaymentValidator.validate()){var e=pSalePaymentMethod.getValues();let t=e.totalCredit;e.paymentMethods.forEach(e=>{t+=e.total}),e.returned<0?SnModal.warning({title:"ALERTA USUARIO",content:"El pago no puede ser menor al monto total"}):t-e.returned!=pSalePrepare.total?SnModal.warning({title:"ALERTA USUARIO",content:"El total de pago es diferente al total de la venta"}):(pSalePrepare.paymentMethods=e.paymentMethods,pSalePrepare.creditCuotes=e.creditCuotes,pSalePrepare.returned=e.returned,e=pSalePrepare.id&&!["","0",null].includes(pSalePrepare.id.toString()),SnLoadingState(!0,"jsAction","salePaymentModalFormSubmit"),RequestApi.fetch("/admin/processSale/"+(e?"update":"save"),{method:"POST",body:pSalePrepare}).then(e=>{var t;e.success?(t=e.result,SnMessage.success({content:e.message}),SnModal.close("salePaymentModal"),0<=[2,3,4,5].indexOf(parseInt(t.documentTypeId))&&(t.sunat.success?SnMessage.success({content:t.sunat.message}):SnMessage.warning({content:t.sunat.message})),iframePrintModal(t.document),newSaleClear()):dynamicResponseErrorModalMessage(e)}).finally(e=>{SnLoadingState(!1,"jsAction","salePaymentModalFormSubmit")}))}else SnModal.warning({title:"ALERTA USUARIO",content:"Verifica los parametros de pago"})}function saleNewSearchProduct(){SnModal.open("productSearchModal"),pProductSearchTable=new SnTable({elementId:"drawSearchProductTable",entity:"product",selectable:!1,data:e=>snTableFetchData("/admin/maintenanceProduct/tableSearch",e),actions:[],columns:[{title:"Código",field:"barcode",filterable:!0,sortable:!0},{title:"Descripción",field:"description",filterable:!0,sortable:!0},{title:"Precio 1",field:"sale_price_1",filterable:!0,sortable:!0},{title:"Precio 2",field:"sale_price_2",filterable:!0,sortable:!0},{title:"Precio 3",field:"sale_price_3",filterable:!0,sortable:!0},{title:"Unidad medida",field:"sale_unit_measure_id_description",filterable:!0,sortable:!0},{title:"Stock",field:"stock",filterable:!0,sortable:!0},{title:'<i class="fa-solid fa-receipt"></i>',tooltip:"Se requiere receta médica para su venta",field:"recipe",style:"width: 32px;",filterable:!0,sortable:!0,customRender:e=>"1"==e.recipe?'<i class="fa-solid fa-check-double" title="Se requiere receta médica para su venta"></i>':""},{title:'<i class="fas fa-puzzle-piece"></i>',tooltip:"Compatibles seleccionados",field:"recipe",style:"width: 32px;",filterable:!0,sortable:!0,customRender:e=>""},{title:'<i class="fas fa-cubes"></i>',tooltip:"Manejo por lotes",style:"width: 32px;",field:"lot",filterable:!0,sortable:!0,customRender:(e,t)=>"1"==e.lot?'<i class="fa-solid fa-check-double" title="Manejo por lotes"></i>':""},{title:'<i class="fas fa-fill"></i>',tooltip:"Este producto maneja varias presentaciones",style:"width: 32px;",field:"recipe",filterable:!0,sortable:!0,customRender:e=>""},{title:"",field:"-",filterable:!1,sortable:!1,customRender:e=>`<div class="SnTable-action not-print">
                                <a href="${URL_PATH}/admin/maintenanceProduct/edit/${e.id}" target="_blank" class="SnBtn icon radio sm jsAction" title="Modificar">
                                    <i class="fas fa-pen"></i>
                                </a>
                            </div>`}],rowRender:(e,t,a)=>`<tr class="${0==e.state?"canceled":""}" key="${e.id}" title="Presiona doble clic en la fila para seleccionar un producto" ondblclick="selectRowProduct(${e.id})" data-params="${a}">
            ${t._buildSelectColumn(e)}
            ${t._buildDataRow(e)}
                        </tr>`})}function selectRowProduct(e){SnModal.close("productSearchModal"),SnLoadingState(!0,"jsAction"),RequestApi.fetch("/admin/maintenanceProduct/idSearch",{method:"POST",body:{id:e}}).then(e=>{e.success?lotSaleProcessPrepareToInsert(e.result.product,e.result.lots):dynamicResponseErrorModalMessage(e)}).finally(e=>{SnLoadingState(!1,"jsAction")})}function productSearchReload(){pProductSearchTable.getData()}function saleNewChangeCustomer(){SnModal.open("customerSearchModal"),pCustomerSearchTable=new SnTable({elementId:"drawSearchCustomerTable",entity:"customer",selectable:!1,data:e=>snTableFetchData("/admin/maintenanceCustomer/tableSearch",e),actions:[],columns:[{title:"Tipo documento",field:"identity_document_id_description",filterable:!0,sortable:!0},{title:"Nº documento",field:"document_number",filterable:!0,sortable:!0},{title:"Razón social",field:"social_reason",filterable:!0,sortable:!0},{title:"Razón comercial",field:"commercial_reason",filterable:!0,sortable:!0},{title:"Dirección",field:"fiscal_address",filterable:!0,sortable:!0},{title:"Email",field:"email",filterable:!0,sortable:!0},{title:"Telefono",field:"telephone",filterable:!0,sortable:!0},{title:"",field:"-",filterable:!1,sortable:!1,customRender:e=>`<div class="SnTable-action not-print">
                                <a href="${URL_PATH}/admin/maintenanceCustomer/edit/${e.id}" target="_blank" class="SnBtn icon radio sm jsAction" title="Modificar">
                                    <i class="fas fa-pen"></i>
                                </a>
                            </div>`}],rowRender:(e,t,a)=>`<tr class="${0==e.state?"canceled":""}" key="${e.id}" ondblclick="selectRowCustomer(${e.id})" title="Presiona doble clic en la fila para seleccionar un cliente" data-params="${a}">
            ${t._buildSelectColumn(e)}
            ${t._buildDataRow(e)}
                        </tr>`})}function selectRowCustomer(e){SnModal.close("customerSearchModal"),SnLoadingState(!0,"jsAction"),RequestApi.fetch("/admin/maintenanceCustomer/idSearch",{method:"POST",body:{id:e}}).then(e=>{e.success?(document.getElementById("saleIdentityDocumentId").value=e.result.identity_document_id,document.getElementById("saleDocumentNumber").value=e.result.document_number,document.getElementById("saleSocialReason").value=e.result.social_reason,document.getElementById("saleFiscalAddress").value=e.result.fiscal_address,document.getElementById("saleEmail").value=e.result.email,document.getElementById("salePhone").value=e.result.telephone,document.getElementById("saleCustomerId").value=e.result.id,document.getElementById("saleCustomerDocumentNumber").value=e.result.document_number):dynamicResponseErrorModalMessage(e)}).finally(e=>{SnLoadingState(!1,"jsAction")})}function customerSearchReload(){pCustomerSearchTable.getData()}function validateChangeDocumentNumber(e){var t=document.getElementById("saleCustomerDocumentNumber");e!==t.value&&(document.getElementById("saleCustomerId").value=0,document.getElementById("saleExpenseWalletCoin").value=0,t.value="",saleItemCalculate())}function saleNewGetWallet(){var e=document.getElementById("saleCustomerId")?.value;if(0<e){const t=document.getElementById("saleTotal")?.value;SnLoadingState(!0,"jsAction"),RequestApi.fetch("/admin/maintenanceCustomer/getSaldoWallet",{method:"POST",body:{id:e}}).then(e=>{e.success?1==e.result.is_default?SnMessage.warning({content:"Seleccione un cliente válido"}):(SnModal.open("walletModal"),document.getElementById("walletCustomerDocumentNumber").innerHTML=e.result.document_number,document.getElementById("walletCustomerSocialReason").innerHTML=e.result.social_reason,document.getElementById("walletCustomerSocialPhone").innerHTML=e.result.telephone,document.getElementById("walletCustomerSocialAddres").innerHTML=e.result.fiscal_address,document.getElementById("walletPoints").value=(e.result.wallet?.saldo??0)*operability.wallet_point,document.getElementById("walletCoins").value=e.result.wallet?.saldo??0,document.getElementById("walletCoinToUse").value=(e.result.wallet?.saldo??0)<t?e.result.wallet?.saldo??0:t):dynamicResponseErrorModalMessage(e)}).finally(e=>{SnLoadingState(!1,"jsAction")})}else SnMessage.warning({content:"Seleccione un cliente"})}function walletModalSubmit(){var e,t;pWalletValidator.validate()?(e=document.getElementById("walletCoinToUse")?.value||0,t=document.getElementById("walletCoins")?.value||0,e=parseFloat(e),(t=parseFloat(t))<e?SnModal.warning({title:"VALIDACIÓN",content:"La cantidad de monedas a disponer no puede ser mayor al disponible.",okClassNames:"warning"}):(document.getElementById("saleExpenseWalletCoin").value=e,saleTotalCalculate(),SnModal.close("walletModal"))):dynamicFormSubmitInvalidMessage()}function saleNewAddFastProduct(){dynamicClearForm(pUncontrolledProductValidator,"uncontrolledProductModalForm","uncontrolledProductDescription"),document.getElementById("uncontrolledProductQuantity").value=1,SnModal.open("uncontrolledProductModal")}function uncontrolledProductModalSubmit(){var e;pUncontrolledProductValidator.validate()?((e={}).quantity=document.getElementById("uncontrolledProductQuantity").value,e.id=-1*(document.querySelector("#saleItemTableBody").childElementCount+1),e.url="",e.description=document.getElementById("uncontrolledProductDescription").value,e.barcode=e.description,e.stock_min=0,e.stock_max=0,e.purchase_price=0,e.lot=0,e.recipe=0,e.sale_price_1=document.getElementById("uncontrolledProductUnitPrice").value,e.sale_price_2=0,e.sale_price_3=0,e.purchase_unit_measure_id=58,e.sale_unit_measure_id=58,e.sale_unit_measure_id_code="NIU",e.factor=1,e.state=1,e.purchase_unit_measure_id_description="UNIDAD(BIENES)",e.sale_unit_measure_id_description="UNIDAD(BIENES)",e.stock=0,e.product_catalog_code="10000000",saleAddItem(e,!1),SnModal.close("uncontrolledProductModal")):dynamicFormSubmitInvalidMessage()}function getIdentityDocumentNumber(e,t){t.classList.add("loading"),RequestApi.fetch("/page/queryDocument",{method:"POST",body:{documentNumber:e}}).then(e=>{var t,a,n;e.success?(t=e.result,document.getElementById("saleDocumentNumber").value=t.document_number,document.getElementById("saleIdentityDocumentId").value=t.document_type_id,document.getElementById("saleFiscalAddress").value=t.full_address,document.getElementById("saleCustomerId").value=0,document.getElementById("saleCustomerDocumentNumber").value=t.document_number,a=document.getElementById("saleTaxpayerCondition"),n=document.getElementById("saleTaxpayerState"),a.innerHTML=`(${t.domicile_condition})`,n.innerHTML=`(${t.taxpayer_state})`,"HABIDO"===t.domicile_condition?a.style.color="var(--green-6)":a.style.color="var(--red-6)","ACTIVO"===t.taxpayer_state?n.style.color="var(--green-6)":n.style.color="var(--red-6)",1==t.document_type_id?document.getElementById("saleSocialReason").value=`${t.full_name} ${t.father_last_name} `+t.mother_last_name:3==t.document_type_id&&(document.getElementById("saleSocialReason").value=t.full_name)):SnModal.danger({title:"Ubo problemas en el buscador de documento",content:e.message})}).finally(e=>{t.classList.remove("loading")})}function saleNewSearchQuotation(){SnModal.open("quotationSearchModal"),pQuotationSearchTable=new SnTable({elementId:"drawSearchQuotationTable",entity:"quotation",selectable:!1,data:e=>snTableFetchData("/admin/processQuotation/tableSearch",e),actions:[],columns:[{title:"Fecha",field:"date_of_issue",type:"date",filterable:!0,sortable:!0},{title:"Number",field:"number",filterable:!0,sortable:!0},{title:"C. Documento",field:"customer_document_number",filterable:!0,sortable:!0},{title:"C. Razón social",field:"customer_social_reason",filterable:!0,sortable:!0},{title:"Gravado",field:"total_taxed",type:"number",filterable:!0,sortable:!0},{title:"Igv",field:"total_igv",type:"number",filterable:!0,sortable:!0},{title:"Total",field:"total",type:"number",filterable:!0,sortable:!0},{title:"Usuario",field:"user_id_user_name",filterable:!0,sortable:!0},{title:"Estado",field:"quotation_state_id_description",filterable:!0,sortable:!0}],rowRender:(e,t,a)=>`<tr class="${0==e.state?"canceled":""}" title="Presiona doble clic en la fila para seleccionar una cotización" key="${e.id}" ondblclick="selectRowQuotation(${e.id})" data-params="${a}">
                        ${t._buildSelectColumn(e)}
                        ${t._buildDataRow(e)}
                    </tr>`})}function quotationSearchReload(){pQuotationSearchTable.getData()}function selectRowQuotation(e){SnModal.close("quotationSearchModal"),SnLoadingState(!0,"jsAction"),RequestApi.fetch("/admin/processQuotation/idSearch",{method:"POST",body:{id:e}}).then(e=>{var t,a;e.success?(newSaleClear(),t=e.result.item,a=e.result,t.forEach(e=>{saleAddItem(e)}),document.getElementById("saleIdentityDocumentId").value=a.customer_identity_document_id,document.getElementById("saleDocumentNumber").value=a.customer_document_number,document.getElementById("saleSocialReason").value=a.customer_social_reason,document.getElementById("saleFiscalAddress").value=a.customer_fiscal_address,document.getElementById("saleEmail").value=a.customer_email):dynamicResponseErrorModalMessage(e)}).finally(e=>{SnLoadingState(!1,"jsAction")})}function saleNewMovement(e){SnModal.open("movementModal"),dynamicClearForm(pMovementValidator,"movementModalForm","movementMovement")}function movementModalSubmit(){var e;pMovementValidator.validate()?((e={}).movement=document.getElementById("movementMovement").value,e.amount=document.getElementById("movementAmount").value,e.methodId=document.getElementById("movementPaymentMethodId").value,e.currencyId=document.getElementById("movementCurrencyId").value,e.description=document.getElementById("movementDescription").value,SnLoadingState(!0,"jsAction","movementModalFormSubmit"),RequestApi.fetch("/admin/processMovement/create",{method:"POST",body:e}).then(e=>{e.success?(SnMessage.success({content:e.message}),SnModal.close("movementModal"),dynamicClearForm(pMovementValidator,"movementModalForm","movementMovement")):dynamicResponseErrorModalMessage(e)}).finally(e=>{SnLoadingState(!1,"jsAction","movementModalFormSubmit")})):dynamicFormSubmitInvalidMessage()}let currentSaleItem={},currentSaleItemInsert={},currentSaleItemLots=[];function lotSaleProcessPrepareToInsert(e,t){var a,n,l=document.getElementById("product_quantity_"+e.id);1==e.lot&&0==operability.lot_automatic_exit?l?(a=parseFloat(l.value)+1,n=document.getElementById("product_"+e.id),currentSaleItem=e,currentSaleItemInsert=!1,currentSaleItemLots=JSON.parse(n.dataset.lots),lotSaleProcessOpen(a)):processQuantityChange(1,!0,e,t.map(e=>({id:e.id,number:e.number,expirationDate:e.expiration_date,manufacturingDate:e.manufacturing_date,initialStock:e.initial_stock,currentStock:e.current_stock,manualQuantity:0,customsName:e.customs_name,customsDocumentDate:e.customs_document_date,petition:e.petition}))):saleAddItem(l?{...e,quantity:parseFloat(l.value)+1}:e)}function processQuantityChange(e,t=!0,a={},n=[]){currentSaleItem=a,currentSaleItemInsert=t,currentSaleItemLots=n,document.getElementById("processQuantityQuantity").value=e,SnModal.open("processQuantityModal")}function processQuantityFormSubmit(e){pProcessQuantityValidator.validate()?(e=e.processQuantityQuantity.value,1==currentSaleItem.lot&&0==operability.lot_automatic_exit?lotSaleProcessOpen(e):(currentSaleItemInsert?saleAddItem({...currentSaleItem,quantity:e}):(document.getElementById("product_quantity_"+currentSaleItem.id).value=e,saleItemCalculate()),SnModal.close("processQuantityModal"))):dynamicFormSubmitInvalidMessage()}function lotSaleProcessOpen(e){document.getElementById("lotSaleProcessTableBody").innerHTML="",currentSaleItemLots.forEach(e=>{lotSaleProcessTableBodyAdd(e)}),document.getElementById("lotSaleProcessProductId").value=currentSaleItem.id,document.getElementById("lotSaleProcessCode").innerHTML=currentSaleItem.barcode,document.getElementById("lotSaleProcessDescription").innerHTML=currentSaleItem.description,document.getElementById("lotSaleProcessQuantity").innerHTML=e,document.getElementById("lotSaleProcessDifference").innerHTML=0,document.getElementById("lotSaleProcessManualOutput").innerHTML=0,document.getElementById("lotSaleProcessFullOutput").innerHTML=0,lotSaleProcessCalculate(),SnModal.open("lotSaleProcessModal")}function lotSaleProcessTableBodyAdd(e){document.getElementById("lotSaleProcessTableBody").insertAdjacentHTML("beforeend",`<tr id="lotSaleProcessBodyRow${e.id}" data-id="${e.id}">
                                                            <td id="lotSaleProcessBodyRowNumber${e.id}">${e.number}</td>
                                                            <td id="lotSaleProcessBodyRowExpirationDate${e.id}">${e.expirationDate}</td>
                                                            <td id="lotSaleProcessBodyRowManufacturingDate${e.id}">${e.manufacturingDate}</td>
                                                            <td id="lotSaleProcessBodyRowInitialStock${e.id}">${e.initialStock}</td>
                                                            <td id="lotSaleProcessBodyRowCurrentStock${e.id}">${e.currentStock}</td>
                                                            <td><input type="number" class="SnForm-control" value="${e.manualQuantity}" id="lotSaleProcessBodyRowManualQuantity${e.id}"></td>
                                                            <td id="lotSaleProcessBodyRowCustomsName${e.id}" class="hidden">${e.customsName}</td>
                                                            <td id="lotSaleProcessBodyRowCustomsDocumentDate${e.id}" class="hidden">${e.customsDocumentDate}</td>
                                                            <td id="lotSaleProcessBodyRowPetition${e.id}" class="hidden">${e.petition}</td>
                                                        </tr>`),document.getElementById("lotSaleProcessBodyRowManualQuantity"+e.id).addEventListener("input",()=>{lotSaleProcessCalculate()}),lotSaleProcessCalculate()}function lotSaleProcessCalculate(){var e=document.getElementById("lotSaleProcessQuantity").innerHTML;let a=0;[...document.getElementById("lotSaleProcessTableBody").children].map((e,t)=>{e=e.dataset.id,e=document.getElementById("lotSaleProcessBodyRowManualQuantity"+e).value;a+=parseFloat(e)});var e=parseFloat(e)-parseFloat(a),t=document.getElementById("lotSaleProcessDifference");return t.innerHTML=e,document.getElementById("lotSaleProcessManualOutput").innerHTML=a,document.getElementById("lotSaleProcessFullOutput").innerHTML=a,t.style.color=0==e?"var(--green-6)":"var(--red-6)",e}function lotSaleProcessModalSubmit(){let m=[],p=document.getElementById("lotSaleProcessProductId").value,y=0;[...document.getElementById("lotSaleProcessTableBody").children].map((e,t)=>{var e=e.dataset.id,a=document.getElementById("lotSaleProcessBodyRowNumber"+e).innerHTML,n=document.getElementById("lotSaleProcessBodyRowExpirationDate"+e).innerHTML,l=document.getElementById("lotSaleProcessBodyRowManufacturingDate"+e).innerHTML,o=document.getElementById("lotSaleProcessBodyRowInitialStock"+e).innerHTML,d=document.getElementById("lotSaleProcessBodyRowCurrentStock"+e).innerHTML,i=document.getElementById("lotSaleProcessBodyRowManualQuantity"+e).value,s=document.getElementById("lotSaleProcessBodyRowCustomsName"+e).innerHTML,r=document.getElementById("lotSaleProcessBodyRowCustomsDocumentDate"+e).innerHTML,c=document.getElementById("lotSaleProcessBodyRowPetition"+e).innerHTML,u={};u.id=e,u.number=a,u.initialStock=o,u.currentStock=d,u.manufacturingDate=l,u.expirationDate=n,u.manualQuantity=i,u.productId=p,u.customsName=s,u.customsDocumentDate=r,u.petition=c,y+=parseFloat(i),m.push(u)});var e=lotSaleProcessCalculate();0!=e?SnModal.warning({title:"ALERTA USUARIO",content:"La cantidad y la salida total debe ser la misma"}):(currentSaleItemInsert?(saleAddItem({...currentSaleItem,quantity:y}),document.getElementById("product_"+currentSaleItem.id).setAttribute("data-lots",JSON.stringify(m))):(document.getElementById("product_quantity_"+currentSaleItem.id).value=y,document.getElementById("product_"+currentSaleItem.id).setAttribute("data-lots",JSON.stringify(m)),saleItemCalculate()),SnModal.close("lotSaleProcessModal"),SnModal.close("processQuantityModal"))}function saleSetDetractionState(){var e,t;document.getElementById("saleDetractionContainerSwitch").checked&&((e=document.getElementById("salePerceptionContainerSwitch")).checked=!1,t=new Event("change"),e.dispatchEvent(t))}function saleSetPerceptionState(){var e,t;document.getElementById("salePerceptionContainerSwitch").checked?(salePerceptionContainer.classList.remove("hidden"),(e=document.getElementById("saleDetractionContainerSwitch")).checked=!1,t=new Event("change"),e.dispatchEvent(t)):salePerceptionContainer.classList.add("hidden")}