let currentResultData,pSummaryTicketValidator;document.addEventListener("DOMContentLoaded",()=>{pSummaryTicketValidator=new Pristine(document.getElementById("saleSummaryTicketForm")),maintenanceTable=new SnTable({elementId:"drawSaleSummaryTable",entity:"saleSummary",data:e=>snTableFetchData("/admin/processSaleSummary/table",e),actions:appMenuActions,selectable:!1,columns:[{title:"Number",field:"number",filterable:!0,sortable:!0},{title:"Fecha generación",field:"date_of_issue",filterable:!0,sortable:!0},{title:"Fecha docs",field:"date_of_reference",filterable:!0,sortable:!0},{title:"Detalle",field:"quantity",filterable:!0,sortable:!0,customRender:e=>`<button type="button" class="SnBtn sm radio" onclick="saleSummaryDetail(${e.id})"><i class="far fa-list-alt SnMr-2"></i>VER <strong>${e.quantity}</strong> OCUMENTOS</button>`},{title:"Ticket",field:"ticket",filterable:!0,sortable:!0},{title:"",field:"-",filterable:!1,sortable:!1,customRender:e=>`<div class="SnTable-action">
                                <button onclick="saleOpenPdf(${e.id})" title="Ver PDF" type="button" class="SnBtn sm icon ${""!=e.pdf_path?"error":"disabled"}" target="_blanck"><i class="fas fa-file-pdf"></i></button>
                                <a href="${URL_PATH+e.xml_path}" title="Descargar XML" download="${e.xml_path.split("/").pop()}" class="SnBtn sm icon ${""!=e.xml_path?"primary":"disabled"}" target="_blanck"><i class="fas fa-file-code"></i></a>
                                <a href="${URL_PATH+e.cdr_path}" title="Descargar CDR" download="${e.cdr_path.split("/").pop()}" class="SnBtn sm icon ${""!=e.cdr_path?"success":"disabled"}" target="_blanck"><i class="fas fa-file-contract"></i></a>
                                ${saleSumaryRenderSunatStateBtn(!0,e.sunat_state,e)}
                                <div class="SnBtn icon radio sm jsAction" title="Mas opciones" onclick="event.preventDefault(); event.stopPropagation(); saleSummaryOpenInvoiceMenu(${e.id},this)"><i class="fas fa-bars"></i></div>
                            </div>`},...snTableAuditColumnRender()],updated:e=>{SnDropdown(),currentResultData=e.result.data},filters:[...getUrlFilter(),...0===getUrlFilter().length?[{id:SnUniqueId(),logicalOperator:"AND",prefix:"DONDE",eval:[{id:SnUniqueId(),logicalOperator:"AND",prefix:"DONDE",operator:"se encuentra entre (incluye)",field:"date_of_issue",type:"date",value1:dayjs().add(-1,"months").format("YYYY-MM-DD"),value2:dayjs().format("YYYY-MM-DD")}]}]:[]]});const a=document.getElementById("saleSummaryTicketForm");a.addEventListener("submit",function(e){e.preventDefault(),saleSummaryTicketFormSubmit(a)})});const saleSumaryRenderSunatStateBtn=(e,a,t)=>{var s=`onclick="event.preventDefault(); event.stopPropagation(); saleSumaryOpenInvoiceInfoMenu(${t.id}, this)"`;switch(a){case"INFORMED":return`<div class="SnDropdown-toggle SnBtn icon radio sm success jsAction ${e?"":"disabled"}" ${s} title="Estado del comprobante"><i class="fas fa-check"></i></div>`;case"SENT":return`<div class="SnDropdown-toggle SnBtn icon radio sm warning jsAction ${e?"":"disabled"}" ${s} title="Estado del comprobante"><i class="fas fa-sync-alt"></i></div>`;case"GENERATED":return`<div class="SnDropdown-toggle SnBtn icon radio sm warning jsAction ${e?"":"disabled"}" ${s} title="Estado del comprobante"><i class="fas fa-redo"></i></div>`;default:return`<div class="SnDropdown-toggle SnBtn icon radio sm jsAction ${e?"primary":"disabled"}" ${s} title="Estado del comprobante"><i class="fas fa-save"></i></div>`}};function saleSumaryOpenInvoiceInfoMenu(a,e){var t=currentResultData.find(e=>e.id==a),t=`<ul class="SnList menu" style="min-width: 300px; max-width: 400px;">
                        <li class="SnList-item flex">ESTADO: <span class="SnMl-4">${t.sunat_state}</span></li>
                        <li class="SnList-item flex">CÓDIGO: <span class="SnMl-4">${t.sunat_response_code}</span></li>
                        <li class="SnList-item flex">FECHA ENVIO: <span class="SnMl-4">${t.date_of_issue}</span></li>
                        <li class="SnList-item flex">FECHA REGISTRO: <span class="SnMl-4">${t.date_of_issue}</span></li>
                        <li class="SnList-item flex" style="white-space: normal">Observación: <span class="SnMl-4">${t.sunat_message}</span></li>
                    </ul>`;maintenanceTable.renderMenuPortal(a,e,t,!0)}function saleSummaryOpenInvoiceMenu(a,e){var t=currentResultData.find(e=>e.id==a),t=`<ul class="SnList menu">
                        ${"INFORMED"!=t.sunat_state?`<li class="SnDropdown-item" onclick="saleSummaryResendSunat(${t.id})"><i class="fas fa-file-import SnMr-2"></i>Reenviar a SUNAT</li>`:""}
                        <li class="SnDropdown-item" onclick="saleSummaryVerifySunat(${t.id})"><i class="fa-solid fa-repeat SnMr-2"></i>Consultar estado SUNAT</li>
                    </ul>`;maintenanceTable.renderMenuPortal(a,e,t,!0)}function saleSummaryDetail(a){SnModal.open("saleSummaryItemModal"),pSaleSummaryItemTable=new SnTable({elementId:"drawSaleSummaryItemTable",entity:"saleSummaryItemQuery",data:e=>snTableFetchData("/admin/processSaleSummary/itemTableBySaleSummary",{...e,saleSummaryId:a}),actions:[],selectable:!1,columns:[{title:"Fecha documento",field:"sale_id_date_of_issue",filterable:!0,sortable:!0,customRender:e=>dayjs(e.sale_id_date_of_issue).format("DD [de] MMMM [del] YYYY")},{title:"Tipo",field:"document_type_id_description",filterable:!0,sortable:!0},{title:"Serie",field:"sale_id_serie",filterable:!0,sortable:!0},{title:"Número",field:"sale_id_number",filterable:!0,sortable:!0},{title:"Total",field:"sale_id_total",filterable:!0,sortable:!0,summaryOperator:"sum",type:"number",customRender:e=>e.currency_id_symbol+" "+e.sale_id_total},{title:"Aceptada",field:"accepted",filterable:!0,sortable:!0,customRender:e=>1==e.accepted?'<i class="fa-solid fa-check" style="color: var(--green-6);"></i>':'<i class="fa-solid fa-xmark" style="color: var(--red-6);"></i>'},{title:"Tipo envio",field:"summary_state_code",filterable:!0,sortable:!0,customRender:e=>{return{1:"Adicionar",2:"Modificar",3:"Anulado"}[e.summary_state_code]??""}},{title:"",field:"view",filterable:!1,sortable:!1,customRender:e=>`<a href="${URL_PATH}/admin/processSale?filter=%5B%7B%22id%22%3A%22881638%22%2C%22logicalOperator%22%3A%22or%22%2C%22prefix%22%3A%22DONDE%22%2C%22eval%22%3A%5B%7B%22id%22%3A%22681626%22%2C%22logicalOperator%22%3A%22and%22%2C%22prefix%22%3A%22DONDE%22%2C%22operator%22%3A%22es%22%2C%22field%22%3A%22document%22%2C%22type%22%3A%22text%22%2C%22value1%22%3A%22${e.sale_id_serie}-${e.sale_id_number}%22%2C%22value2%22%3A%22%22%7D%5D%7D%5D" target="_blank">VER</a>`},{title:"",field:"sunat",filterable:!1,sortable:!1,customRender:e=>`<button class="SnBtn sm radio" onclick="sunatSummaryItemQuerySunat(${e.id})"><img src="${URL_PATH}/images/sunat_logo.png" style="width: 16px; height: 16px; display: inline-block; transform: translateY(2px);" class="SnMr-2" alt="icon">Verificar Estado en SUNAT</button>`}]})}function saleSummaryResendSunat(e){SnLoadingState(!0,"jsAction"),RequestApi.fetch("/admin/processSaleSummary/resendSunat",{method:"POST",body:{id:e}}).then(e=>{var a=e.result;SnMessage.success({content:e.message}),e.success?(a.success?SnMessage.success({content:a.message}):SnModal.danger({title:"SUNAT ERROR",content:a.message}),maintenanceTable.getData()):dynamicResponseErrorModalMessage(e)}).finally(e=>{SnLoadingState(!1,"jsAction")})}function saleSummaryVerifySunat(e){SnLoadingState(!0,"jsAction"),RequestApi.fetch("/admin/processSaleSummary/verifySunat",{method:"POST",body:{id:e}}).then(e=>{var a=e.result;SnMessage.success({content:e.message}),e.success?(a.success?SnMessage.success({content:a.message}):SnModal.danger({title:"SUNAT ERROR",content:a.message}),maintenanceTable.getData()):dynamicResponseErrorModalMessage(e)}).finally(e=>{SnLoadingState(!1,"jsAction")})}function sunatSummaryItemQuerySunat(e){SnLoadingState(!0,"jsAction"),RequestApi.fetch("/admin/processSaleSummary/querySunat",{method:"POST",body:{id:e}}).then(e=>{var a;e.success?(a=e.result,SnMessage.success({content:e.message}),a.success?SnModal.success({title:"RESPUESTA SUNAT",content:a.message}):SnModal.danger({title:"RESPUESTA SUNAT",content:a.message})):dynamicResponseErrorModalMessage(e)}).finally(e=>{SnLoadingState(!1,"jsAction")})}function saleSummarySeeHistory(e,a,[t]){SnLoadingState(!0,"jsAction"),RequestApi.fetch("/admin/seeCommunication/log",{method:"POST",body:{id:t,from:"SUMMARY"}}).then(e=>{e.success?(document.getElementById("drawSeeCommunicationTable").innerHTML=e.view,SnModal.open("seeCommunicationModal")):dynamicResponseErrorModalMessage(e)}).finally(e=>{SnLoadingState(!1,"jsAction")})}function saleSummarySetTicket(e,a,[t]){dynamicClearForm(pSummaryTicketValidator,"saleSummaryTicketForm","saleSummaryTicketCode"),document.getElementById("saleSummaryTicketId").value=t,SnModal.open("saleSummaryTicketModal")}function saleSummaryTicketFormSubmit(a){if(pSummaryTicketValidator.validate()){let e={};e.id=a.saleSummaryTicketId.value,e.ticket=a.saleSummaryTicketCode.value,SnModal.confirm({title:"¿Estás seguro de actualizar el ticket de este resumen de diario?",okText:"Si",okClassNames:"danger",cancelText:"No",onOk(){SnLoadingState(!0,"jsAction","saleSummaryTicketFormSubmit"),RequestApi.fetch("/admin/processSaleSummary/setTicket",{method:"POST",body:e}).then(e=>{e.success?(SnModal.success({title:"PROCESO COMPLETO",content:e.message}),SnModal.close("saleSummaryTicketModal"),maintenanceTable.getData()):dynamicResponseErrorModalMessage(e)}).finally(e=>{SnLoadingState(!1,"jsAction","saleSummaryTicketFormSubmit")})}})}else dynamicFormSubmitInvalidMessage()}