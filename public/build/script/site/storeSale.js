let pSaleValidator,pSalePaymentValidator,pUncontrolledProductValidator,pSalePrepare,pProcessQuantityValidator,slimSaleDetractionOriginLocationId,slimSaleDetractionArrivalLocationId,slimSaleGuideOriginLocationId,slimSaleGuideDeliveryLocationId;function saleNewMoreOption(){SnModal.open("saleHeaderMoreOption")}function saleSetOperationTypeValues(){var e=parseInt(document.getElementById("saleOperationTypeId").value||0);document.getElementById("saleDetractionContainerWrapper").classList.toggle("hidden",![3,5,6,7].includes(e)),document.getElementById("saleDetractionContainerTransWrapper").classList.toggle("hidden",![5].includes(e)),document.getElementById("saleDetractionContainerHidroWrapper").classList.toggle("hidden",![6].includes(e))}function saleSetTaxFactor(){var e=document.getElementById("saleTaxId"),t=document.querySelectorAll(".jsTaxPercentaje");const a=100*(e.options[e.selectedIndex].getAttribute("data-factor")||0);[...t].forEach(e=>{e.innerHTML=a+"%"}),saleItemCalculate()}function saleSetCurrencySymbol(t){[...document.querySelectorAll(".jsCurrencySymbol")].forEach(e=>{e.innerHTML=t})}function saleSetDefaultValues(){const t=document.getElementById("saleDocumentTypeId");t.addEventListener("change",e=>{saleSetDefaultPdfSize(t),saleSetDefaultIdentityDocumentId(t),saleSetWareHouses(t),saleItemCalculate()}),saleSetDefaultPdfSize(t),saleSetDefaultIdentityDocumentId(t),saleSetWareHouses(t),saleSetOperationTypeValues()}function setDefaultCustomer(){defaultCustomer&&"id"in defaultCustomer&&(document.getElementById("saleIdentityDocumentId").value=defaultCustomer.identity_document_id,document.getElementById("saleDocumentNumber").value=defaultCustomer.document_number,document.getElementById("saleSocialReason").value=defaultCustomer.social_reason,document.getElementById("saleFiscalAddress").value=defaultCustomer.fiscal_address,document.getElementById("saleEmail").value=defaultCustomer.email,document.getElementById("salePhone").value=defaultCustomer.telephone,document.getElementById("saleCustomerId").value=defaultCustomer.id)}function saleSetDefaultPdfSize(e){var t=document.getElementById("salePdfFormat"),e=e.options[e.selectedIndex].getAttribute("data-pdfsize");e&&(t.value=e)}function saleSetDefaultIdentityDocumentId(e){var t=document.getElementById("saleIdentityDocumentId");switch(e.value){case"1":t.value="1";break;case"2":t.value="3";break;case"3":t.value="1"}}function saleSetWareHouses(e){const t=e.value,a=document.getElementById("saleSerie");e=wareHouseSeries.filter(e=>e.document_type_id===t);a.innerHTML="",e.forEach(e=>{a.insertAdjacentHTML("beforeend",`<option value="${e.serie}">${e.serie}</option>`)})}function saleNewSubmit(){if(pSaleValidator.validate()){let S=(new Date).getFullYear();var e=document.getElementById("saleTaxId"),t={id:0},e=(t.wareHouseId=document.getElementById("wareHouseId").value,t.companyId=document.getElementById("companyId").value,t.userId=document.getElementById("userId").value,t.cashBoxId=document.getElementById("cashBoxId").value,t.dateOfIssue=document.getElementById("saleDateOfIssue").value,t.dateOfDue=document.getElementById("saleDateOfDue").value,t.creditDebitTypeId=0,t.referenceSerie="",t.changeType="",t.vehiclePlate=document.getElementById("saleVehiclePlate").value,t.purchaseOrder=document.getElementById("salePurchaseOrder").value,t.pdfFormat=document.getElementById("salePdfFormat").value,t.guide=document.getElementById("saleGuide").value,t.observation=document.getElementById("saleObservation").value,t.documentNumber=document.getElementById("saleDocumentNumber").value,t.socialReason=document.getElementById("saleSocialReason").value,t.fiscalAddress=document.getElementById("saleFiscalAddress").value,t.email=document.getElementById("saleEmail").value,t.phone=document.getElementById("salePhone").value,t.emailSend=!0,t.phoneSend=!0,t.customerId=document.getElementById("saleCustomerId").value,t.identityDocumentId=document.getElementById("saleIdentityDocumentId").value,t.totalFree=document.getElementById("saleTotalFree").value,t.totalExportation=document.getElementById("saleTotalExportation").value,t.totalDiscount=document.getElementById("saleTotalDiscount").value,t.totalExonerated=document.getElementById("saleTotalExonerated").value,t.totalUnaffected=document.getElementById("saleTotalUnaffected").value,t.totalTaxed=document.getElementById("saleTotalTaxed").value,t.totalIgv=document.getElementById("saleTotalIgv").value,t.totalCharge=document.getElementById("saleTotalCharge").value,t.totalValue=document.getElementById("saleTotalValue").value,t.totalPlasticBagTax=document.getElementById("saleTotalPlasticBagTax").value,t.total=document.getElementById("saleTotal").value,t.documentTypeId=document.getElementById("saleDocumentTypeId").value,t.serie=document.getElementById("saleSerie").value,t.currencyId=document.getElementById("saleCurrencyId").value,t.operationTypeId=document.getElementById("saleOperationTypeId").value,t.globalDiscount=document.getElementById("saleTotalGlobalDiscount").value,t.taxFactor=e.options[e.selectedIndex].getAttribute("data-factor"),t.detractionEnabled=document.getElementById("saleDetractionContainerSwitch").checked,t.detractionTypeCat54Id=document.getElementById("saleDetractionTypeCat54Id").value,t.detractionFactor=document.getElementById("saleDetractionFactor").value,t.detractionOriginLocationId=document.getElementById("saleDetractionOriginLocationId").value,t.detractionOriginAddress=document.getElementById("saleDetractionOriginAddress").value,t.detractionArrivalLocationId=document.getElementById("saleDetractionArrivalLocationId").value,t.detractionArrivalAddress=document.getElementById("saleDetractionArrivalAddress").value,t.detractionReferralValue=document.getElementById("saleDetractionReferralValue").value,t.detractionEffectiveLoad=document.getElementById("saleDetractionEffectiveLoad").value,t.detractionUsefulLoad=document.getElementById("saleDetractionUsefulLoad").value,t.detractionTravelDetail=document.getElementById("saleDetractionTravelDetail").value,t.detractionBoatRegistration=document.getElementById("saleDetractionBoatRegistration").value,t.detractionBoatName=document.getElementById("saleDetractionBoatName").value,t.detractionSpeciesKind=document.getElementById("saleDetractionSpeciesKind").value,t.detractionDeliveryAddress=document.getElementById("saleDetractionDeliveryAddress").value,t.detractionQuantity=document.getElementById("saleDetractionQuantity").value,t.detractionDeliveryDate=document.getElementById("saleDetractionDeliveryDate").value,t.perceptionTypeCat22Id=document.getElementById("salePerceptionTypeCat22Id").value,t.guideTransferTypeCat20Id=document.getElementById("saleGuideTransferTypeCat20Id").value,t.guideTransportTypeCat18Id=document.getElementById("saleGuideTransportTypeCat18Id").value,t.guideTransferStartDate=document.getElementById("saleGuideTransferStartDate").value,t.guideTotalGrossWeight=document.getElementById("saleGuideTotalGrossWeight").value,t.guideCarrierIdentityDocumentTypeId=document.getElementById("saleGuideCarrierIdentityDocumentTypeId").value,t.guideCarrierDocumentNumber=document.getElementById("saleGuideCarrierDocumentNumber").value,t.guideCarrierDenomination=document.getElementById("saleGuideCarrierDenomination").value,t.guideCarrierPlateNumber=document.getElementById("saleGuideCarrierPlateNumber").value,t.guideDriverIdentityDocumentTypeId=document.getElementById("saleGuideDriverIdentityDocumentTypeId").value,t.guideDriverDocumentNumber=document.getElementById("saleGuideDriverDocumentNumber").value,t.guideDriverFullName=document.getElementById("saleGuideDriverFullName").value,t.guideOriginLocationId=document.getElementById("saleGuideOriginLocationId").value,t.guideOriginAddress=document.getElementById("saleGuideOriginAddress").value,t.guideDeliveryLocationId=document.getElementById("saleGuideDeliveryLocationId").value,t.guideDeliveryAddress=document.getElementById("saleGuideDeliveryAddress").value,t.itinerantLocationId=document.getElementById("saleItinerantLocationId").value,t.itinerantAddress=document.getElementById("saleItinerantAddress").value,t.itinerantUrbanization=document.getElementById("saleItinerantUrbanization").value,t.saleItems=[],document.getElementById("saleItemTableBody"));t.saleItems=[...e.children].map((e,t)=>{var a=e.id.split("_")[1],n=e.dataset.controlled,e=JSON.parse(e.dataset.lots||[]),d=document.getElementById("product_unit_price_"+a).value,o=document.getElementById("product_affectation_igv_type_id_"+a).value,l=document.getElementById("product_icbper_"+a).checked,i=document.getElementById("product_quantity_"+a).value,s=document.getElementById("product_discount_"+a).value,r=document.getElementById("product_unit_value_"+a).value,c=document.getElementById("product_total_value_"+a).value,u=document.getElementById("product_igv_"+a).value,m=document.getElementById("product_total_base_igv_"+a).value,y=document.getElementById("product_total_"+a).innerHTML,p=document.getElementById("product_barcode_"+a).value,I=document.getElementById("product_sale_unit_measure_id_"+a).value;let g=document.getElementById("product_description_"+a).innerHTML;var v=document.getElementById("product_description_aditional_"+a).value,E=document.getElementById("product_lot_"+a).value,B=document.getElementById("product_recipe_"+a).value,v=(0<v.trim().length&&(g+=" "+v),i=parseFloat(i),l?i*(2022===S?.4:.5):0);return{controlled:n,productCode:p,description:g,quantity:i,unitValue:r,unitPrice:d,discount:s,charge:0,affectationIgvTypeId:o,totalBaseIgv:m,igv:u,totalValue:c,total:y,plasticBagTax:v,unitMeasureId:I,productId:1==n?a:null,lot:E,recipe:B,lots:e}}),saleValidateProcess(t)&&saleShowSalePaymentModal(t)}else dynamicFormSubmitInvalidMessage()}function saleValidateProcess(e){return 0==e.saleItems.lenght?(SnModal.warning({title:"ALERTA USUARIO",content:"Ingrese al menos un producto en los detalles"}),!1):0<=e.total||(SnModal.warning({title:"ALERTA USUARIO",content:"El total no puede ser menor que 0"}),!1)}function searchProductByCode(e){var t=document.getElementById("wareHouseId").value,a=document.getElementById("companyId").value,n=document.getElementById("userId").value;SnLoadingState(!0,"jsAction"),RequestApi.fetch("/store/saleProductBarCodeSearch",{method:"POST",body:{barCode:e,wareHouseId:t,companyId:a,userId:n}}).then(e=>{e.success?e.result.product?(SnMessage.success({content:"Producto encontrado"}),lotSaleProcessPrepareToInsert(e.result.product,e.result.lots)):SnMessage.warning({content:"No se encontró ningún producto"}):dynamicResponseErrorModalMessage(e)}).finally(e=>{SnLoadingState(!1,"jsAction")})}function saleAddItem(l,e=!0){var t=document.getElementById("saleItemTableBody"),a=document.getElementById("product_"+l.id),n=1==operability.sale_items_with_taxes;let d="";affectationIgvTypes.forEach(e=>{d+=`<option value="${e.id}">${e.description}</option>`}),a?document.getElementById("product_quantity_"+l.id).value=l.quantity||1:(t.insertAdjacentHTML("beforeend",`<tr id="product_${l.id}" data-controlled="${e?1:0}" data-lots="[]">
                                                            <td>
                                                                <input id="product_quantity_${l.id}" min="0" ${"0"==operability.lot_automatic_exit?'style="width: 70px; background: transparent; border-color: transparent;"':'style="width: 80px"'} type="number" class="SnForm-control" value="${l.quantity||1}">
                                                                <input id="product_barcode_${l.id}" type="hidden" class="SnForm-control" value="${l.barcode}">
                                                                <input id="product_sale_unit_measure_id_${l.id}" type="hidden" class="SnForm-control" value="${l.sale_unit_measure_id}">
                                                                <input id="product_lot_${l.id}" type="hidden" class="SnForm-control" value="${l.lot}">
                                                                <input id="product_recipe_${l.id}" type="hidden" class="SnForm-control" value="${l.recipe}">
                                                            </td>
                                                            <td id="product_description_${l.id}">${l.description}</td>
                                                            <td>
                                                                <input id="product_description_aditional_${l.id}" type="text" class="SnForm-control" style="min-width: 80px">
                                                            </td>
                                                            <td id="product_lot_check_${l.id}">${"1"==l.lot?'<i class="fa-solid fa-check-double" title="Manejo por lotes"></i>':""}</td>
                                                            <td id="product_stock_${l.id}">${parseFloat(l.stock)} ${l.sale_unit_measure_id_code}</td>
                                                            <td>
                                                                <input id="product_unit_price_${l.id}" min="0" type="${n?"number":"hidden"}" class="SnForm-control" value="${l.sale_price_1}">
                                                                <input id="product_unit_value_${l.id}" min="0" type="${n?"hidden":"number"}" class="SnForm-control" value="${l.sale_price_1}">
                                                            </td>
                                                            <td>
                                                                <select id="product_affectation_igv_type_id_${l.id}" class="SnForm-control">${d}</select>
                                                                <input id="product_total_base_igv_${l.id}" type="hidden" class="SnForm-control" value="0">
                                                                <input id="product_igv_${l.id}" type="hidden" class="SnForm-control" value="0">
                                                            </td>
                                                            <td class="hidden">
                                                                <input id="product_total_value_${l.id}" min="0" type="number" class="SnForm-control" value="0" readonly title="Subtotal">
                                                            </td>
                                                            <td class="hidden">
                                                                <input id="product_discount_${l.id}" min="0" type="number" class="SnForm-control" value="0" style="width: 80px" title="Descuento por Item o Línea (aplica al Subtotal)">
                                                            </td>
                                                            <td id="product_total_${l.id}"></td>
                                                            <td style="text-align: center;"><input type="checkbox" id="product_icbper_${l.id}"></td>
                                                            <td>
                                                                <button id="product_remove_${l.id}" class="SnBtn error icon radio" type="button"><i class="fas fa-trash"></i></button>
                                                            </td>
                                                        </tr>`),0<l.affectation_igv_type_id&&(document.getElementById("product_affectation_igv_type_id_"+l.id).value=l.affectation_igv_type_id),"0"==operability.lot_automatic_exit?document.getElementById("product_quantity_"+l.id).addEventListener("dblclick",e=>{var t=document.getElementById("product_lot_"+l.id).value,a=document.getElementById("product_quantity_"+l.id).value,n=document.getElementById("product_description_"+l.id).innerHTML,d=document.getElementById("product_"+l.id).dataset.lots,o=document.getElementById("product_"+l.id).dataset.controlled;processQuantityChange(a,!1,{quantity:a,lot:t,id:l.id,description:n,controlled:o},JSON.parse(d||[]))}):document.getElementById("product_quantity_"+l.id).addEventListener("change",e=>{saleItemCalculate()}),document.getElementById("product_discount_"+l.id).addEventListener("change",e=>{saleItemCalculate()}),document.getElementById("product_unit_price_"+l.id).addEventListener("change",e=>{saleItemCalculate()}),document.getElementById("product_unit_value_"+l.id).addEventListener("change",e=>{saleItemCalculate()}),document.getElementById("product_affectation_igv_type_id_"+l.id).addEventListener("change",e=>{saleItemCalculate()}),document.getElementById("product_icbper_"+l.id).addEventListener("change",e=>{saleItemCalculate()}),document.getElementById("product_remove_"+l.id).addEventListener("click",e=>{saleItemRemove(l.id)})),saleItemCalculate()}function saleItemRemove(e){document.getElementById("product_"+e).remove(),saleItemCalculate()}function saleItemCalculate(){let m=1==operability.sale_items_with_taxes;var e=document.getElementById("saleTaxId");let y=e.options[e.selectedIndex].getAttribute("data-factor")||0,p=(y=parseFloat(y),"1"!=document.getElementById("saleDocumentTypeId").value);[...document.getElementById("saleItemTableBody").children].map((e,t)=>{e=e.id.split("_")[1];let a=document.getElementById("product_unit_price_"+e).value||0;var n=document.getElementById("product_affectation_igv_type_id_"+e),d=document.getElementById("product_icbper_"+e),o=document.getElementById("product_quantity_"+e).value||0,l=document.getElementById("product_discount_"+e).value||0;let i=document.getElementById("product_unit_value_"+e).value||0;p?(n.parentElement.classList.remove("hidden"),d.parentElement.classList.remove("hidden"),document.getElementById("productAffectationIgvTypeCol").classList.remove("hidden"),document.getElementById("productICBPERCol").classList.remove("hidden")):(n.parentElement.classList.add("hidden"),d.parentElement.classList.add("hidden"),document.getElementById("productAffectationIgvTypeCol").classList.add("hidden"),document.getElementById("productICBPERCol").classList.add("hidden"));d=n.value;a=parseFloat(a),d=parseInt(d),o=parseFloat(o),l=parseFloat(l),i=parseFloat(i);let s,r,c,u;p?(s=(c=m?1===d?(i=a/(1+y),u=o*i-l,(r=u)*y):(i=a,u=o*i-l,r=u,0):1===d?(a=i*(1+y),u=o*i-l,(r=u)*y):(a=i,u=o*i-l,r=u,0),u+c),document.getElementById("product_unit_price_"+e).value=a,document.getElementById("product_unit_value_"+e).value=i):(u=o*(m?a:i)-l,r=u,c=0,s=u+c),document.getElementById("product_total_base_igv_"+e).value=r,document.getElementById("product_igv_"+e).value=c,document.getElementById("product_total_value_"+e).value=u,document.getElementById("product_total_"+e).innerHTML=s.toFixed(2)}),saleTotalCalculate()}function saleGetGlobalDiscount(e){return{discountFactor:0,discountAmount:0}}function saleTotalCalculate(){var e=document.getElementById("saleTaxId"),e=e.options[e.selectedIndex].getAttribute("data-factor")||0,e=parseFloat(e);let s=0,r=0,c=0,u=0,m=0,y=0,p=0,I=0,g=0,v=0;var t=1!=document.getElementById("saleDocumentTypeId").value,a=((new Date).getFullYear(),[...document.getElementById("saleItemTableBody").children].map((e,t)=>{var e=e.id.split("_")[1],a=document.getElementById("product_affectation_igv_type_id_"+e).value,n=document.getElementById("product_icbper_"+e).checked,d=document.getElementById("product_quantity_"+e).value,o=document.getElementById("product_discount_"+e).value,l=document.getElementById("product_total_value_"+e).value,e=document.getElementById("product_igv_"+e).value,a=parseInt(a),d=parseFloat(d),o=parseFloat(o),l=parseFloat(l),e=parseFloat(e),i=(v+=n?.5*d:0,l+e);switch(a){case 1:s+=i,m+=l;break;case 8:s+=i,r+=l;break;case 9:s+=i,c+=l;break;case 2:case 3:case 4:case 5:case 6:case 7:case 10:case 11:case 12:case 13:case 14:case 15:p+=l;break;case 16:s+=i,u+=l}y+=o,g+=d,I++}),saleGetGlobalDiscount(s));let n=0,d=0,o=0,l=0,i=0;0<a.discountFactor&&(n=r*a.discountFactor,d=c*a.discountFactor,o=u*a.discountFactor,l=m*a.discountFactor,i=n+d+o+l);var a=p,E=r-n,B=c-d,S=u-o,f=m-l,_=i+y,e=t?f*e:0,h=B+f+E+S,T=h+e+parseFloat(document.getElementById("saleTotalCharge").value||0)+v;document.getElementById("summaryTotalLines").innerHTML=I,document.getElementById("summaryTotalCuantity").innerHTML=g,document.getElementById("summaryTotalWeight").innerHTML=0,document.getElementById("saleSubTotalContainer").classList.remove("hidden"),document.getElementById("saleSubTotal").value=s.toFixed(2),document.getElementById("saleSubTotalHtml").innerHTML=s.toFixed(2),a&&t?document.getElementById("saleTotalFreeContainer").classList.remove("hidden"):document.getElementById("saleTotalFreeContainer").classList.add("hidden"),document.getElementById("saleTotalFree").value=a.toFixed(2),document.getElementById("saleTotalFreeHtml").innerHTML=a.toFixed(2),S&&t?document.getElementById("saleTotalExportationContainer").classList.remove("hidden"):document.getElementById("saleTotalExportationContainer").classList.add("hidden"),document.getElementById("saleTotalExportation").value=S.toFixed(2),document.getElementById("saleTotalExportationHtml").innerHTML=S.toFixed(2),0<i?document.getElementById("saleTotalGlobalDiscountContainer").classList.remove("hidden"):document.getElementById("saleTotalGlobalDiscountContainer").classList.add("hidden"),document.getElementById("saleTotalGlobalDiscount").value=i.toFixed(2),document.getElementById("saleTotalGlobalDiscountHtml").innerHTML=i.toFixed(2),0<y?document.getElementById("saleTotalItemDiscountContainer").classList.remove("hidden"):document.getElementById("saleTotalItemDiscountContainer").classList.add("hidden"),document.getElementById("saleTotalItemDiscount").value=y.toFixed(2),document.getElementById("saleTotalItemDiscountHtml").innerHTML=y.toFixed(2),0<_?document.getElementById("saleTotalDiscountContainer").classList.remove("hidden"):document.getElementById("saleTotalDiscountContainer").classList.add("hidden"),document.getElementById("saleTotalDiscount").value=_.toFixed(2),document.getElementById("saleTotalDiscountHtml").innerHTML=_.toFixed(2),0<E&&t?document.getElementById("saleTotalExoneratedContainer").classList.remove("hidden"):document.getElementById("saleTotalExoneratedContainer").classList.add("hidden"),document.getElementById("saleTotalExonerated").value=E.toFixed(2),document.getElementById("saleTotalExoneratedHtml").innerHTML=E.toFixed(2),0<B&&t?document.getElementById("saleTotalUnaffectedContainer").classList.remove("hidden"):document.getElementById("saleTotalUnaffectedContainer").classList.add("hidden"),document.getElementById("saleTotalUnaffected").value=B.toFixed(2),document.getElementById("saleTotalUnaffectedHtml").innerHTML=B.toFixed(2),0<f&&t?document.getElementById("saleTotalTaxedContainer").classList.remove("hidden"):document.getElementById("saleTotalTaxedContainer").classList.add("hidden"),document.getElementById("saleTotalTaxed").value=f.toFixed(2),document.getElementById("saleTotalTaxedHtml").innerHTML=f.toFixed(2),0<e&&t?document.getElementById("saleTotalIgvContainer").classList.remove("hidden"):document.getElementById("saleTotalIgvContainer").classList.add("hidden"),document.getElementById("saleTotalIgv").value=e.toFixed(2),document.getElementById("saleTotalIgvHtml").innerHTML=e.toFixed(2),document.getElementById("saleTotalValue").value=h.toFixed(2),0<v?document.getElementById("saleTotalPlasticBagTaxContainer").classList.remove("hidden"):document.getElementById("saleTotalPlasticBagTaxContainer").classList.add("hidden"),document.getElementById("saleTotalPlasticBagTax").value=v.toFixed(2),document.getElementById("saleTotalPlasticBagTaxHtml").innerHTML=v.toFixed(2),document.getElementById("saleTotal").value=T.toFixed(2),document.getElementById("saleTotalHtml").innerHTML=T.toFixed(2)}function newSaleClear(){dynamicClearForm(pSaleValidator,"newSaleForm","saleSearchProductCode","saleItemTableBody"),dynamicClearForm(pSalePaymentValidator,"salePaymentModalForm"),document.getElementById("saleSubTotalHtml").innerHTML=0,document.getElementById("saleTotalFreeHtml").innerHTML=0,document.getElementById("saleTotalExportationHtml").innerHTML=0,document.getElementById("saleTotalDiscountHtml").innerHTML=0,document.getElementById("saleTotalExoneratedHtml").innerHTML=0,document.getElementById("saleTotalUnaffectedHtml").innerHTML=0,document.getElementById("saleTotalTaxedHtml").innerHTML=0,document.getElementById("saleTotalIgvHtml").innerHTML=0,document.getElementById("saleTotalChargeHtml").innerHTML=0,document.getElementById("saleTotalValueHtml").innerHTML=0,document.getElementById("saleTotalPlasticBagTaxHtml").innerHTML=0,document.getElementById("saleTotalHtml").innerHTML=0,document.getElementById("saleTaxpayerState").innerHTML="",document.getElementById("saleTaxpayerCondition").innerHTML="",document.getElementById("saleTotal").value=0,pSalePaymentMethod?.clearValues(),saleSetDefaultValues()}function saleNewList(e,t){window.location.href=URL_PATH+"/admin/"+t}document.addEventListener("DOMContentLoaded",()=>{pSaleValidator=dynamicLoadFormValidate(pSaleValidator,"newSaleForm"),pSalePaymentValidator=dynamicLoadFormValidate(pSalePaymentValidator,"salePaymentModalForm"),pUncontrolledProductValidator=dynamicLoadFormValidate(pUncontrolledProductValidator,"uncontrolledProductModalForm"),pProcessQuantityValidator=dynamicLoadFormValidate(pProcessQuantityValidator,"processQuantityForm"),document.getElementById("newSaleForm").addEventListener("submit",function(e){e.preventDefault(),saleNewSubmit()}),document.getElementById("salePaymentModalForm").addEventListener("submit",function(e){e.preventDefault(),salePaymentModalSubmit()}),document.getElementById("userPinCodeModalForm").addEventListener("submit",function(e){e.preventDefault(),saleVerifyPinCodeModalSubmit()}),document.getElementById("uncontrolledProductModalForm").addEventListener("submit",function(e){e.preventDefault(),uncontrolledProductModalSubmit()});const t=document.getElementById("saleSearchProductCode"),a=(t.addEventListener("keypress",function(e){"Enter"===e.key&&e.preventDefault()}),t.addEventListener("keyup",function(e){"Enter"===e.key&&(e.preventDefault(),searchProductByCode(e.target.value),t.value="")}),SnLiveList({elem:"#saleSearchProductDescription",data:(e,a)=>{var t,n,d;e.length<4?a("Escriba almenos 4 caracteres"):(a("Cargando..."),t=document.getElementById("wareHouseId").value,n=document.getElementById("companyId").value,d=document.getElementById("userId").value,SnLoadingState(!0,"jsAction"),RequestApi.fetch("/store/saleProductDescriptionSearch",{method:"POST",body:{description:e,wareHouseId:t,companyId:n,userId:d}}).then(e=>{var t;e.success?(t=e.result.map(e=>({...e,text:e.description,value:e.id})),a(t)):a(e.message)}).finally(e=>{SnLoadingState(!1,"jsAction")}))},onSelect:(e,t)=>{lotSaleProcessPrepareToInsert(t,t.lots),document.getElementById("saleSearchProductDescription").value="",document.getElementById("saleSearchProductDescription").focus()}}),document.getElementById("saleDocumentNumber")),n=(a.addEventListener("keypress",function(e){"Enter"===e.key&&e.preventDefault()}),a.addEventListener("keyup",function(e){"Enter"===e.key&&(e.preventDefault(),getIdentityDocumentNumber(e.target.value,a))}),document.getElementById("saleOperationTypeId").addEventListener("change",function(e){e.preventDefault(),saleSetOperationTypeValues()}),saleSetOperationTypeValues(),document.getElementById("saleCurrencyId")),d=(n.addEventListener("change",function(e){e.preventDefault(),saleSetCurrencySymbol(n.options[n.selectedIndex].getAttribute("data-symbol")),saleTotalCalculate()}),saleSetCurrencySymbol(n.options[n.selectedIndex].getAttribute("data-symbol")),document.getElementById("saleTaxId").addEventListener("change",function(e){e.preventDefault(),saleSetTaxFactor()}),saleSetTaxFactor(),document.getElementById("saleTotalCharge").addEventListener("input",()=>{saleTotalCalculate()}),document.getElementById("processQuantityForm"));d.addEventListener("submit",function(e){e.preventDefault(),processQuantityFormSubmit(d)}),saleSetDefaultValues(),setDefaultCustomer(),document.getElementById("saleDetractionContainerSwitch").addEventListener("change",()=>{saleSetDetractionState()}),saleSetDetractionState(),document.getElementById("salePerceptionContainerSwitch").addEventListener("change",()=>{saleSetPerceptionState()}),saleSetPerceptionState()});class SnPayment{constructor(e){this.options=e,this.paymentMethodFocus=0,this.total=0,this.paymentMethods=[],this.creditNumberCuotes=0,this.setDefaultValues(),this.renderBase()}setDefaultValues(){this.options.paymentMethods?this.paymentMethods=this.options.paymentMethods:this.paymentMethods=[{id:1,description:"Efectivo",total:0,reference:"",dateOfDue:"",icon:"fas fa-money-bill-wave"},{id:2,description:"Tarjeta",total:0,reference:"",dateOfDue:"",icon:"fas fa-credit-card"},{id:5,description:"Banco",total:0,reference:"",dateOfDue:"",icon:"fas fa-university"},{id:6,description:"App",total:0,reference:"",dateOfDue:"",icon:"fas fa-mobile-alt"}]}clearValues(){this.paymentMethods.forEach(e=>{document.getElementById("snPaymentMethod"+e.id).value=0}),document.getElementById("salePaymentTotalTop").innerHTML="",document.getElementById("salePaymentTotalDescriptionTop").innerHTML="",document.getElementById("snPaymentMethodReference").value=""}setTotal(e){this.total=parseFloat(e),this.clearValues(),document.getElementById("salePaymentTotalTop").innerHTML=parseFloat(this.total).toFixed(2),document.getElementById("salePaymentTotalDescriptionTop").innerHTML=numToWordCurrency(parseFloat(this.total).toFixed(2)),this.initPayment(!1)}getValues(){let a=[],n=0;[...document.getElementById("snPaymentCreditTableBody").children].forEach(e=>{var t={};t.cuote=document.getElementById("snPaymentCreditRowCuote_"+e.dataset.id).value,t.total=document.getElementById("snPaymentCreditRowAmount_"+e.dataset.id).value,t.dateOfDue=document.getElementById("snPaymentCreditRowDateOfDue_"+e.dataset.id).value,t.total=parseFloat(t.total),a.push(t),n+=t.total});var e=document.getElementById("snPaymentTotalTurned").innerHTML,e=parseFloat(e);return{paymentMethods:this.paymentMethods,creditCuotes:a,totalCredit:n,returned:e}}renderBase(){document.getElementById(this.options.elementId).innerHTML=`<div class="SnGrid col-gap s-grid-${this.paymentMethods.length}">
                                    ${this.paymentMethods.map(e=>`<div class="SnForm-item inner required">
                                                    <label for="snPaymentMethod${e.id}" class="SnForm-label">${e.description}</label>
                                                    <div class="SnControl-wrapper">
                                                        <i class="${e.icon} SnControl-prefix"></i>
                                                        <input type="number" class="SnForm-control sm SnControl" id="snPaymentMethod${e.id}" required value="0">
                                                    </div>
                                                </div>`).join("")}
                                </div>

                                <div class="SnControlGroup">
                                    <div class="SnControlGroup-prepend">
                                        <div class="SnControlGroup-prepend-text">Referencia</div>
                                    </div>
                                    <div class="SnControlGroup-input">
                                        <input class="SnForm-control" type="text" placeholder="Referencia" id="snPaymentMethodReference">
                                    </div>
                                </div>

                                <div class="SnDivider"></div>

                                <div class="SnGrid col-gap s-grid-2">
                                    <div class="SalePaymentSummay-left">
                                        <span>Total, a crédito </span>
                                        <span class="SalePaymentSummay-credit" id="gymPaymentTotalCredit">0.00</span>
                                        <button type="button" class="SnBtn warning SnMt-2" id="snPaymentCreditToggle"><i class="fas fa-plus SnMr-2"></i> Agregar credito</button>
                                    </div>
                                    <div class="SalePaymentSummay-right">
                                        <div>Cambio</div>
                                        <div class="SalePaymentSummay-turned success" id="snPaymentTotalTurned">0.00</div>
                                    </div>
                                </div>

                                <div id="snPaymentCreditContainer" class="hidden">
                                    <div class="SnDivider"><strong>PAGO A CREDITO</strong></div>
                                    <table class="SnTable SnMb-4">
                                        <thead>
                                            <tr>
                                                <th>Cuota</th>
                                                <th>Monto</th>
                                                <th>Fecha vencimiento</th>
                                                <th></th>
                                            </tr>
                                        </thead>
                                        <tbody id="snPaymentCreditTableBody"></tbody>
                                    </table>
                                    <button type="button" class="SnBtn radio block SnMb-5" id="snPaymentCreditAddCuote"><i class="fas fa-plus SnMr-2"></i>Agregar cuota</button>
                                </div>
                                `;const a=document.getElementById("snPaymentMethodReference");var e=document.getElementById("snPaymentCreditToggle");const t=document.getElementById("snPaymentCreditContainer");this.paymentMethods.forEach(t=>{var e=document.getElementById("snPaymentMethod"+t.id);e.addEventListener("input",e=>{e.preventDefault(),this.calculate()}),e.addEventListener("focus",e=>{e.preventDefault(),this.paymentMethodFocus=t.id,a.value=this.getReference(t.id)})}),a.addEventListener("input",e=>{e.preventDefault(),this.setReference(a.value)}),e.addEventListener("click",e=>{e.preventDefault(),this.initPayment(t.classList.contains("hidden"))}),document.getElementById("snPaymentCreditAddCuote").addEventListener("click",e=>{this.addCreditCuote()})}initPayment(e=!1){var t=document.getElementById("snPaymentCreditContainer"),a=document.getElementById("snPaymentCreditToggle");e?(t.classList.remove("hidden"),a.innerHTML='<i class="fas fa-minus SnMr-2"></i> Quitar credito',this.initPaymentCredit()):(t.classList.add("hidden"),a.innerHTML='<i class="fas fa-plus SnMr-2"></i> Agregar credito',this.initPaymentCash())}initPaymentCash(){this.setDefaultValues();var e=this.paymentMethods[0],e=document.getElementById("snPaymentMethod"+e.id);e.value=this.total.toFixed(2),e.focus(),document.getElementById("snPaymentCreditTableBody").innerHTML="",this.calculate()}initPaymentCredit(){this.paymentMethods.forEach(e=>{document.getElementById("snPaymentMethod"+e.id).value=0}),this.addCreditCuote({amount:this.total})}removeCreditCuote(e){document.getElementById("snPaymentCreditRow_"+e).remove(),0===[...document.getElementById("snPaymentCreditTableBody").children].length?(this.initPaymentCash(),document.getElementById("snPaymentCreditContainer").classList.add("hidden"),document.getElementById("snPaymentCreditToggle").innerHTML='<i class="fas fa-plus SnMr-2"></i> Agregar credito'):this.calculate()}addCreditCuote(t={}){t.cuote=[...document.getElementById("snPaymentCreditTableBody").children].length+1,snPaymentCreditTableBody.insertAdjacentHTML("beforeend",`<tr id="snPaymentCreditRow_${t.cuote}" data-id="${t.cuote}">
                        <td><input type="text" id="snPaymentCreditRowCuote_${t.cuote}" class="SnForm-control" value="${t.cuote}" disabled></td>
                        <td><input type="number" id="snPaymentCreditRowAmount_${t.cuote}" class="SnForm-control" value="${t.amount||0}"></td>
                        <td><input type="date" id="snPaymentCreditRowDateOfDue_${t.cuote}" class="SnForm-control" value="${t.dateOfDue||""}"></td>
                        <td><button type="button" class="SnBtn radio icon" id="snPaymentCreditRowRemove_${t.cuote}"><i class="fas fa-trash-alt"></i></button></td>
                    </tr>`);var e=document.getElementById("snPaymentCreditRowAmount_"+t.cuote);e.addEventListener("input",e=>{this.calculate()}),document.getElementById("snPaymentCreditRowDateOfDue_"+t.cuote).addEventListener("input",e=>{this.calculate()}),document.getElementById("snPaymentCreditRowRemove_"+t.cuote).addEventListener("click",e=>{this.removeCreditCuote(t.cuote)}),e.focus(),this.calculate()}getReference(t){var e=this.paymentMethods.find(e=>e.id===t);return null!=e?e.reference:""}setReference(t){this.paymentMethods=this.paymentMethods.map(e=>e.id===this.paymentMethodFocus?{...e,reference:t}:e)}calculate(){var e=document.getElementById("snPaymentTotalTurned");let a=0,t=(this.paymentMethods.forEach((e,t)=>{e=document.getElementById("snPaymentMethod"+e.id);a+=parseFloat(e.value),this.paymentMethods[t].total=parseFloat(e.value)}),0);[...document.getElementById("snPaymentCreditTableBody").children].forEach(e=>{e=document.getElementById("snPaymentCreditRowAmount_"+e.dataset.id);t+=parseFloat(e.value)});var n=this.total-a,d=(a+t-this.total).toFixed(2);document.getElementById("gymPaymentTotalCredit").innerHTML=(0<n?n:0).toFixed(2),0<=(e.innerHTML=d)?(e.classList.add("success"),e.classList.remove("error")):(e.classList.add("error"),e.classList.remove("success"))}}let pSalePaymentCurrentFocus="",pSalePaymentMethod=null;function saleShowSalePaymentModal(e){pSalePrepare=e,(pSalePaymentMethod=null===pSalePaymentMethod?new SnPayment({elementId:"salePaymentMethodsWrapper"}):pSalePaymentMethod).setTotal(e.total),SnModal.open("salePaymentModal")}function salePaymentModalSubmit(){if(pSalePaymentValidator.validate()){var e=pSalePaymentMethod.getValues();let t=e.totalCredit;e.paymentMethods.forEach(e=>{t+=e.total}),e.returned<0?SnModal.warning({title:"ALERTA USUARIO",content:"El pago no puede ser menor al monto total"}):t-e.returned!=pSalePrepare.total?SnModal.warning({title:"ALERTA USUARIO",content:"El total de pago es diferente al total de la venta"}):(pSalePrepare.paymentMethods=e.paymentMethods,pSalePrepare.creditCuotes=e.creditCuotes,pSalePrepare.returned=e.returned,SnModal.open("userPinCodeModal"))}else SnModal.warning({title:"ALERTA USUARIO",content:"Verifica los parametros de pago"})}function setPincodeValue(e){var t=document.getElementById("userPinCodeCode");t.value=""+t.value+e}function clearPincodeValue(){document.getElementById("userPinCodeCode").value=""}async function saleVerifyPinCodeModalSubmit(){SnLoadingState(!0,"jsAction","userPinCodeModalSubmit");var e=document.getElementById("userPinCodeCode").value,t=document.getElementById("userId").value,e=await RequestApi.fetch("/user/verifyPincode",{method:"POST",body:{pinCode:e,userId:t}});e.success?(SnMessage.success({content:e.message}),SnModal.close("userPinCodeModal"),SnLoadingState(!0,"jsAction","salePaymentModalFormSubmit"),RequestApi.fetch("/store/saleSave",{method:"POST",body:pSalePrepare}).then(e=>{var t;e.success?(t=e.result,SnMessage.success({content:e.message}),SnModal.close("salePaymentModal"),0<=[2,3,4,5].indexOf(parseInt(t.documentTypeId))?t.sunat.success?(SnMessage.success({content:t.sunat.message}),iframePrintModal(t.document)):(SnModal.danger({title:"SUNAT ERROR",content:t.sunat.message}),SnMessage.danger({content:t.sunat.message})):iframePrintModal(t.document),newSaleClear()):dynamicResponseErrorModalMessage(e)}).finally(e=>{SnLoadingState(!1,"jsAction","salePaymentModalFormSubmit")})):dynamicResponseErrorModalMessage(e),SnLoadingState(!1,"jsAction","userPinCodeModalSubmit")}function saleNewSearchProduct(){SnModal.open("productSearchModal");let t=document.getElementById("wareHouseId").value,a=document.getElementById("companyId").value,n=document.getElementById("userId").value;pProductSearchTable=new SnTable({elementId:"drawSearchProductTable",entity:"product",selectable:!1,data:e=>snTableFetchData("/store/saleProductTableSearch",{...e,wareHouseId:t,companyId:a,userId:n}),actions:[],columns:[{title:"Código",field:"barcode",filterable:!0,sortable:!0},{title:"Descripción",field:"description",filterable:!0,sortable:!0},{title:"Precio 1",field:"sale_price_1",filterable:!0,sortable:!0},{title:"Precio 2",field:"sale_price_2",filterable:!0,sortable:!0},{title:"Precio 3",field:"sale_price_3",filterable:!0,sortable:!0},{title:"Unidad medida",field:"sale_unit_measure_id_description",filterable:!0,sortable:!0},{title:"Stock",field:"stock",filterable:!0,sortable:!0},{title:'<i class="fa-solid fa-receipt"></i>',tooltip:"Se requiere receta médica para su venta",field:"recipe",style:"width: 32px;",filterable:!0,sortable:!0,customRender:e=>"1"==e.recipe?'<i class="fa-solid fa-check-double" title="Se requiere receta médica para su venta"></i>':""},{title:'<i class="fas fa-puzzle-piece"></i>',tooltip:"Compatibles seleccionados",field:"recipe",style:"width: 32px;",filterable:!0,sortable:!0,customRender:e=>""},{title:'<i class="fas fa-cubes"></i>',tooltip:"Manejo por lotes",style:"width: 32px;",field:"lot",filterable:!0,sortable:!0,customRender:(e,t)=>"1"==e.lot?'<i class="fa-solid fa-check-double" title="Manejo por lotes"></i>':""},{title:'<i class="fas fa-fill"></i>',tooltip:"Este producto maneja varias presentaciones",style:"width: 32px;",field:"recipe",filterable:!0,sortable:!0,customRender:e=>""}],rowRender:(e,t,a)=>`<tr class="${0==e.state?"canceled":""}" key="${e.id}" title="Presiona doble clic en la fila para seleccionar un producto" ondblclick="selectRowProduct(${e.id})" data-params="${a}">
            ${t._buildSelectColumn(e)}
            ${t._buildDataRow(e)}
                        </tr>`})}function selectRowProduct(e){SnModal.close("productSearchModal");var t=document.getElementById("wareHouseId").value;SnLoadingState(!0,"jsAction"),RequestApi.fetch("/store/saleProductIdSearch",{method:"POST",body:{id:e,wareHouseId:t}}).then(e=>{e.success?lotSaleProcessPrepareToInsert(e.result.product,e.result.lots):dynamicResponseErrorModalMessage(e)}).finally(e=>{SnLoadingState(!1,"jsAction")})}function productSearchReload(){pProductSearchTable.getData()}function saleNewChangeCustomer(){SnModal.open("customerSearchModal");let t=document.getElementById("companyId").value;pCustomerSearchTable=new SnTable({elementId:"drawSearchCustomerTable",entity:"customer",selectable:!1,data:e=>snTableFetchData("/store/saleCustomerTableSearch",{...e,companyId:t}),actions:[],columns:[{title:"Tipo documento",field:"identity_document_id_description",filterable:!0,sortable:!0},{title:"Nº documento",field:"document_number",filterable:!0,sortable:!0},{title:"Razón social",field:"social_reason",filterable:!0,sortable:!0},{title:"Razón comercial",field:"commercial_reason",filterable:!0,sortable:!0},{title:"Dirección",field:"fiscal_address",filterable:!0,sortable:!0},{title:"Email",field:"email",filterable:!0,sortable:!0},{title:"Telefono",field:"telephone",filterable:!0,sortable:!0}],rowRender:(e,t,a)=>`<tr class="${0==e.state?"canceled":""}" key="${e.id}" ondblclick="selectRowCustomer(${e.id})" title="Presiona doble clic en la fila para seleccionar un cliente" data-params="${a}">
            ${t._buildSelectColumn(e)}
            ${t._buildDataRow(e)}
                        </tr>`})}function selectRowCustomer(e){SnModal.close("customerSearchModal"),SnLoadingState(!0,"jsAction"),RequestApi.fetch("/store/saleCustomerIdSearch",{method:"POST",body:{id:e}}).then(e=>{e.success?(document.getElementById("saleIdentityDocumentId").value=e.result.identity_document_id,document.getElementById("saleDocumentNumber").value=e.result.document_number,document.getElementById("saleSocialReason").value=e.result.social_reason,document.getElementById("saleFiscalAddress").value=e.result.fiscal_address,document.getElementById("saleEmail").value=e.result.email,document.getElementById("salePhone").value=e.result.telephone,document.getElementById("saleCustomerId").value=e.result.id):dynamicResponseErrorModalMessage(e)}).finally(e=>{SnLoadingState(!1,"jsAction")})}function customerSearchReload(){pCustomerSearchTable.getData()}function saleNewAddFastProduct(){dynamicClearForm(pUncontrolledProductValidator,"uncontrolledProductModalForm","uncontrolledProductDescription"),document.getElementById("uncontrolledProductQuantity").value=1,SnModal.open("uncontrolledProductModal")}function uncontrolledProductModalSubmit(){var e;pUncontrolledProductValidator.validate()?((e={}).quantity=document.getElementById("uncontrolledProductQuantity").value,e.id=-1*(document.querySelector("#saleItemTableBody").childElementCount+1),e.url="",e.description=document.getElementById("uncontrolledProductDescription").value,e.barcode=e.description,e.stock_min=0,e.stock_max=0,e.purchase_price=0,e.lot=0,e.recipe=0,e.sale_price_1=document.getElementById("uncontrolledProductUnitPrice").value,e.sale_price_2=e.sale_price_1,e.sale_price_3=e.sale_price_1,e.purchase_unit_measure_id=58,e.sale_unit_measure_id=58,e.sale_unit_measure_id_code="NIU",e.factor=1,e.state=1,e.purchase_unit_measure_id_description="UNIDAD(BIENES)",e.sale_unit_measure_id_description="UNIDAD(BIENES)",e.stock=0,saleAddItem(e,!1),SnModal.close("uncontrolledProductModal")):dynamicFormSubmitInvalidMessage()}function getIdentityDocumentNumber(e,t){t.classList.add("loading"),RequestApi.fetch("/page/queryDocument",{method:"POST",body:{documentNumber:e}}).then(e=>{var t,a,n;e.success?(t=e.result,document.getElementById("saleDocumentNumber").value=t.document_number,document.getElementById("saleIdentityDocumentId").value=t.document_type_id,document.getElementById("saleFiscalAddress").value=t.full_address,document.getElementById("saleCustomerId").value=0,a=document.getElementById("saleTaxpayerCondition"),n=document.getElementById("saleTaxpayerState"),a.innerHTML=`(${t.domicile_condition})`,n.innerHTML=`(${t.taxpayer_state})`,"HABIDO"===t.domicile_condition?a.style.color="var(--green-6)":a.style.color="var(--red-6)","ACTIVO"===t.taxpayer_state?n.style.color="var(--green-6)":n.style.color="var(--red-6)",1==t.document_type_id?document.getElementById("saleSocialReason").value=`${t.full_name} ${t.father_last_name} `+t.mother_last_name:3==t.document_type_id&&(document.getElementById("saleSocialReason").value=t.full_name)):SnModal.danger({title:"Ubo problemas en el buscador de documento",content:e.message})}).finally(e=>{t.classList.remove("loading")})}let currentSaleItem={},currentSaleItemInsert={},currentSaleItemLots=[];function lotSaleProcessPrepareToInsert(e,t){var a,n,d=document.getElementById("product_quantity_"+e.id);1==e.lot&&0==operability.lot_automatic_exit?d?(a=parseFloat(d.value)+1,n=document.getElementById("product_"+e.id),currentSaleItem=e,currentSaleItemInsert=!1,currentSaleItemLots=JSON.parse(n.dataset.lots),lotSaleProcessOpen(a)):processQuantityChange(1,!0,e,t.map(e=>({id:e.id,number:e.number,expirationDate:e.expiration_date,manufacturingDate:e.manufacturing_date,initialStock:e.initial_stock,currentStock:e.current_stock,manualQuantity:0,customsName:e.customs_name,customsDocumentDate:e.customs_document_date,petition:e.petition}))):saleAddItem(d?{...e,quantity:parseFloat(d.value)+1}:e)}function processQuantityChange(e,t=!0,a={},n=[]){currentSaleItem=a,currentSaleItemInsert=t,currentSaleItemLots=n,document.getElementById("processQuantityQuantity").value=e,SnModal.open("processQuantityModal")}function processQuantityFormSubmit(e){pProcessQuantityValidator.validate()?(e=e.processQuantityQuantity.value,1==currentSaleItem.lot&&0==operability.lot_automatic_exit?lotSaleProcessOpen(e):(currentSaleItemInsert?saleAddItem({...currentSaleItem,quantity:e}):(document.getElementById("product_quantity_"+currentSaleItem.id).value=e,saleItemCalculate()),SnModal.close("processQuantityModal"))):dynamicFormSubmitInvalidMessage()}function lotSaleProcessOpen(e){document.getElementById("lotSaleProcessTableBody").innerHTML="",currentSaleItemLots.forEach(e=>{lotSaleProcessTableBodyAdd(e)}),document.getElementById("lotSaleProcessProductId").value=currentSaleItem.id,document.getElementById("lotSaleProcessCode").innerHTML=currentSaleItem.barcode,document.getElementById("lotSaleProcessDescription").innerHTML=currentSaleItem.description,document.getElementById("lotSaleProcessQuantity").innerHTML=e,document.getElementById("lotSaleProcessDifference").innerHTML=0,document.getElementById("lotSaleProcessManualOutput").innerHTML=0,document.getElementById("lotSaleProcessFullOutput").innerHTML=0,lotSaleProcessCalculate(),SnModal.open("lotSaleProcessModal")}function lotSaleProcessTableBodyAdd(e){document.getElementById("lotSaleProcessTableBody").insertAdjacentHTML("beforeend",`<tr id="lotSaleProcessBodyRow${e.id}" data-id="${e.id}">
                                                            <td id="lotSaleProcessBodyRowNumber${e.id}">${e.number}</td>
                                                            <td id="lotSaleProcessBodyRowExpirationDate${e.id}">${e.expirationDate}</td>
                                                            <td id="lotSaleProcessBodyRowManufacturingDate${e.id}">${e.manufacturingDate}</td>
                                                            <td id="lotSaleProcessBodyRowInitialStock${e.id}">${e.initialStock}</td>
                                                            <td id="lotSaleProcessBodyRowCurrentStock${e.id}">${e.currentStock}</td>
                                                            <td><input type="number" class="SnForm-control" value="${e.manualQuantity}" id="lotSaleProcessBodyRowManualQuantity${e.id}"></td>
                                                            <td id="lotSaleProcessBodyRowCustomsName${e.id}" class="hidden">${e.customsName}</td>
                                                            <td id="lotSaleProcessBodyRowCustomsDocumentDate${e.id}" class="hidden">${e.customsDocumentDate}</td>
                                                            <td id="lotSaleProcessBodyRowPetition${e.id}" class="hidden">${e.petition}</td>
                                                        </tr>`),document.getElementById("lotSaleProcessBodyRowManualQuantity"+e.id).addEventListener("input",()=>{lotSaleProcessCalculate()}),lotSaleProcessCalculate()}function lotSaleProcessCalculate(){var e=document.getElementById("lotSaleProcessQuantity").innerHTML;let a=0;[...document.getElementById("lotSaleProcessTableBody").children].map((e,t)=>{e=e.dataset.id,e=document.getElementById("lotSaleProcessBodyRowManualQuantity"+e).value;a+=parseFloat(e)});var e=parseFloat(e)-parseFloat(a),t=document.getElementById("lotSaleProcessDifference");return t.innerHTML=e,document.getElementById("lotSaleProcessManualOutput").innerHTML=a,document.getElementById("lotSaleProcessFullOutput").innerHTML=a,t.style.color=0==e?"var(--green-6)":"var(--red-6)",e}function lotSaleProcessModalSubmit(){let m=[],y=document.getElementById("lotSaleProcessProductId").value,p=0;[...document.getElementById("lotSaleProcessTableBody").children].map((e,t)=>{var e=e.dataset.id,a=document.getElementById("lotSaleProcessBodyRowNumber"+e).innerHTML,n=document.getElementById("lotSaleProcessBodyRowExpirationDate"+e).innerHTML,d=document.getElementById("lotSaleProcessBodyRowManufacturingDate"+e).innerHTML,o=document.getElementById("lotSaleProcessBodyRowInitialStock"+e).innerHTML,l=document.getElementById("lotSaleProcessBodyRowCurrentStock"+e).innerHTML,i=document.getElementById("lotSaleProcessBodyRowManualQuantity"+e).value,s=document.getElementById("lotSaleProcessBodyRowCustomsName"+e).innerHTML,r=document.getElementById("lotSaleProcessBodyRowCustomsDocumentDate"+e).innerHTML,c=document.getElementById("lotSaleProcessBodyRowPetition"+e).innerHTML,u={};u.id=e,u.number=a,u.initialStock=o,u.currentStock=l,u.manufacturingDate=d,u.expirationDate=n,u.manualQuantity=i,u.productId=y,u.customsName=s,u.customsDocumentDate=r,u.petition=c,p+=parseFloat(i),m.push(u)});var e=lotSaleProcessCalculate();0!=e?SnModal.warning({title:"ALERTA USUARIO",content:"La cantidad y la salida total debe ser la misma"}):(currentSaleItemInsert?(saleAddItem({...currentSaleItem,quantity:p}),document.getElementById("product_"+currentSaleItem.id).setAttribute("data-lots",JSON.stringify(m))):(document.getElementById("product_quantity_"+currentSaleItem.id).value=p,document.getElementById("product_"+currentSaleItem.id).setAttribute("data-lots",JSON.stringify(m)),saleItemCalculate()),SnModal.close("lotSaleProcessModal"),SnModal.close("processQuantityModal"))}function saleSetDetractionState(){var e,t;document.getElementById("saleDetractionContainerSwitch").checked&&((e=document.getElementById("salePerceptionContainerSwitch")).checked=!1,t=new Event("change"),e.dispatchEvent(t))}function saleSetPerceptionState(){var e,t;document.getElementById("salePerceptionContainerSwitch").checked?(salePerceptionContainer.classList.remove("hidden"),(e=document.getElementById("saleDetractionContainerSwitch")).checked=!1,t=new Event("change"),e.dispatchEvent(t)):salePerceptionContainer.classList.add("hidden")}